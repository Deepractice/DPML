# DPML Agent 测试用例

本文档描述了`@dpml/agent`包的单元测试和集成测试用例，旨在保证代理模块的功能正确性、稳定性和安全性。`@dpml/agent`作为DPML的核心领域包，负责定义和运行基于LLM的智能代理。

## 1. 标签定义与注册测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-A-001 | 基础标签注册 | 测试3个核心标签(agent、llm、prompt)的注册 | 所有标签被正确注册到TagRegistry |
| UT-A-002 | 标签属性验证 | 测试标签属性定义与验证 | 各标签属性正确验证，必需属性检查有效 |
| UT-A-003 | 标签嵌套规则 | 测试标签嵌套规则定义 | 正确验证嵌套关系，拒绝非法嵌套 |
| UT-A-004 | 标签ID唯一性 | 测试标签ID唯一性验证 | 重复ID被检测并报错 |
| UT-A-005 | 自定义验证规则 | 测试自定义验证逻辑 | 自定义验证规则生效并返回预期结果 |

## 2. 标签处理器测试

### 2.1 AgentTagProcessor

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-AP-001 | 基本属性处理 | 测试基本属性(id, version)处理 | 属性被正确提取到元数据 |
| UT-AP-002 | 子标签收集 | 测试必需子标签的收集与验证 | 子标签被正确收集并验证完整性 |
| UT-AP-003 | extends属性处理 | 测试代理继承处理 | 正确提取和记录extends属性值（继承逻辑由Core包处理） |

### 2.2 LLMTagProcessor

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-LP-001 | 基本LLM配置处理 | 测试LLM基本属性处理 | LLM配置属性被正确提取到元数据 |
| UT-LP-002 | api-type检验 | 测试api-type属性验证 | 验证api-type值在支持范围内 |
| UT-LP-003 | api-url验证 | 测试api-url属性验证 | 验证api-url是有效URL |
| UT-LP-004 | key-env安全处理 | 测试密钥环境变量名处理 | 密钥环境变量名被安全处理，不记录实际密钥值 |
| UT-LP-005 | 模型验证 | 测试model属性验证 | 验证model值合法性 |
| UT-LP-006 | extends属性处理 | 测试LLM配置继承处理 | 正确提取和记录extends属性值（继承逻辑由Core包处理） |

### 2.3 PromptTagProcessor

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-APP-001 | 基本提示词处理 | 测试提示词基本处理 | 提示词内容被正确提取 |
| UT-APP-002 | 提示词委托处理 | 测试提示词委托给@dpml/prompt处理 | 成功委托处理，获取正确结果 |
| UT-APP-003 | extends属性处理 | 测试提示词继承处理 | 正确提取和记录extends属性值（继承逻辑由Core包处理） |

## 3. API密钥管理测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-KEY-001 | 环境变量获取 | 测试从环境变量获取API密钥 | 成功从环境变量获取API密钥 |
| UT-KEY-002 | 密钥格式验证 | 测试API密钥格式验证 | 验证密钥格式符合提供商要求 |
| UT-KEY-003 | 环境变量缺失处理 | 测试环境变量不存在情况 | 提供明确错误信息，指出环境变量不存在 |
| UT-KEY-004 | 密钥值安全处理 | 测试密钥值的安全处理 | 密钥值不被记录到日志或错误信息中 |
| UT-KEY-005 | 运行时密钥更新 | 测试运行时更新API密钥 | 成功更新密钥且不中断已有会话 |
| UT-KEY-006 | 环境变量轮换支持 | 测试支持多个环境变量轮换调用 | 在主密钥失效时自动尝试备用密钥 |
| UT-KEY-007 | 密钥加载优先级 | 测试密钥加载优先级 | 遵循环境变量>配置文件>默认值的优先级 |

## 4. LLM连接器测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-LC-001 | OpenAI连接器基础 | 测试OpenAI API基础连接 | 成功连接并调用OpenAI API |
| UT-LC-002 | Anthropic连接器基础 | 测试Anthropic API基础连接 | 成功连接并调用Anthropic API |
| UT-LC-003 | 本地模型连接器 | 测试本地模型连接 | 成功连接并调用本地模型 |
| UT-LC-004 | 连接超时处理 | 测试连接超时处理 | 连接超时被正确处理，提供明确错误 |
| UT-LC-005 | 请求重试机制 | 测试请求重试机制 | 临时错误时自动重试指定次数 |
| UT-LC-006 | 错误响应处理 | 测试错误响应处理 | API错误被正确解析并转换为友好信息 |
| UT-LC-007 | 速率限制处理 | 测试速率限制处理 | 检测到速率限制时自动等待或降级 |
| UT-LC-008 | 流式响应处理 | 测试流式响应处理 | 成功处理流式响应并正确分块 |
| UT-LC-009 | token计算功能 | 测试token计算功能 | 准确计算输入文本的token数量 |
| UT-LC-010 | token使用统计 | 测试token使用统计 | 正确记录输入和输出token使用量 |

## 5. 代理状态管理测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-ST-001 | 状态创建与初始化 | 测试代理状态初始化 | 状态被正确初始化为默认值 |
| UT-ST-002 | 状态转换基础 | 测试基本状态转换 | 状态按预期在各状态间转换 |
| UT-ST-003 | 无效状态转换 | 测试无效状态转换处理 | 检测并拒绝无效的状态转换 |
| UT-ST-004 | 状态事件触发 | 测试状态变更事件 | 状态变更时正确触发对应事件 |
| UT-ST-005 | 状态持久化 | 测试状态序列化与持久化 | 状态能被正确序列化和反序列化 |
| UT-ST-006 | 状态恢复 | 测试从持久化状态恢复 | 成功从持久化数据恢复状态 |
| UT-ST-007 | 超时状态处理 | 测试状态超时处理 | 检测状态超时并正确处理 |
| UT-ST-008 | 并发状态访问 | 测试并发状态访问 | 并发访问时保持状态一致性 |

## 6. 记忆系统测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-MEM-001 | 基本记忆存储 | 测试基本记忆项存储 | 记忆项被正确存储和检索 |
| UT-MEM-002 | 会话记忆管理 | 测试会话记忆管理 | 会话记忆被正确关联到对应会话 |
| UT-MEM-003 | 记忆检索 | 测试记忆检索功能 | 成功检索指定会话的记忆 |
| UT-MEM-004 | 记忆清除 | 测试记忆清除功能 | 成功清除指定会话的记忆 |
| UT-MEM-005 | 内存存储实现 | 测试内存存储实现 | 内存存储实现正常工作 |
| UT-MEM-006 | 文件系统存储实现 | 测试文件系统存储实现 | 文件系统存储实现正常工作 |
| UT-MEM-007 | 长期记忆检索 | 测试长期记忆检索 | 成功基于查询检索相关记忆 |
| UT-MEM-008 | 记忆压缩 | 测试记忆压缩功能 | 成功压缩冗长对话历史 |
| UT-MEM-009 | 记忆优先级处理 | 测试记忆优先级处理 | 重要记忆被优先保留 |
| UT-MEM-010 | 记忆容量限制 | 测试记忆容量限制 | 到达容量限制时正确处理 |

## 7. 事件系统测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-EV-001 | 事件注册与触发 | 测试基本事件机制 | 事件被正确注册和触发 |
| UT-EV-002 | 生命周期事件 | 测试代理生命周期事件 | 生命周期事件按预期触发 |
| UT-EV-003 | 处理阶段事件 | 测试处理阶段事件 | 处理阶段事件按预期触发 |
| UT-EV-004 | 异步事件处理 | 测试异步事件处理 | 异步事件处理符合预期 |
| UT-EV-005 | 事件错误处理 | 测试事件处理器错误 | 事件处理器错误被正确捕获 |
| UT-EV-006 | 事件参数传递 | 测试事件参数传递 | 参数被正确传递给事件处理器 |
| UT-EV-007 | 事件监听器移除 | 测试监听器移除功能 | 监听器被正确移除 |

## 8. 代理执行测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-EX-001 | 基本执行流程 | 测试基本代理执行流程 | 执行流程按预期进行 |
| UT-EX-002 | 输入处理 | 测试输入处理逻辑 | 输入被正确处理和验证 |
| UT-EX-003 | 上下文构建 | 测试对话上下文构建 | 上下文正确包含系统提示和历史 |
| UT-EX-004 | LLM调用 | 测试LLM调用过程 | LLM被正确调用并获取响应 |
| UT-EX-005 | 响应处理 | 测试响应处理逻辑 | 响应被正确解析和处理 |
| UT-EX-006 | 流式执行 | 测试流式执行模式 | 流式执行正确传递部分响应 |
| UT-EX-007 | 会话管理 | 测试多会话管理 | 多个会话被正确隔离和处理 |
| UT-EX-008 | 执行中断 | 测试执行中断机制 | 执行可以被正确中断 |
| UT-EX-009 | 执行恢复 | 测试执行恢复机制 | 中断的执行可以被恢复 |
| UT-EX-010 | 超时处理 | 测试执行超时处理 | 超时被检测并正确处理 |

## 9. 错误处理测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-ERR-001 | 解析错误处理 | 测试DPML语法错误处理 | 提供友好错误信息，包含位置 |
| UT-ERR-002 | 验证错误处理 | 测试标签验证错误处理 | 提供明确的验证错误信息 |
| UT-ERR-003 | LLM连接错误 | 测试LLM连接错误处理 | 提供明确的连接错误信息 |
| UT-ERR-004 | API认证错误 | 测试API认证错误处理 | 提供清晰的认证错误信息，不暴露密钥 |
| UT-ERR-005 | 速率限制错误 | 测试速率限制错误处理 | 提供速率限制信息和建议 |
| UT-ERR-006 | 记忆系统错误 | 测试记忆系统错误处理 | 提供记忆系统错误信息 |
| UT-ERR-007 | 重试策略测试 | 测试错误重试策略 | 临时错误按策略重试 |
| UT-ERR-008 | 降级策略测试 | 测试服务降级策略 | 在主要服务不可用时尝试备用选项 |
| UT-ERR-009 | 错误恢复测试 | 测试从错误恢复能力 | 非致命错误后能继续执行 |

## 10. 安全测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-SEC-001 | API密钥保护 | 测试API密钥保护机制 | API密钥不被记录或暴露 |
| UT-SEC-002 | 环境变量验证 | 测试环境变量存在性验证 | 环境变量缺失被及时检测 |
| UT-SEC-003 | 输入验证与过滤 | 测试输入验证和净化 | 潜在危险输入被正确验证和过滤 |
| UT-SEC-004 | 敏感信息处理 | 测试敏感信息处理 | 敏感信息被正确保护 |
| UT-SEC-005 | 日志安全审查 | 测试日志安全控制 | 日志不包含敏感信息 |
| UT-SEC-006 | 错误信息安全 | 测试错误信息安全 | 错误信息不暴露敏感实现细节 |
| UT-SEC-007 | 路径遍历防护 | 测试路径遍历防护 | 防止引用路径造成安全问题 |

## 11. 集成测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| IT-A-001 | 端到端基本流程 | 测试完整代理处理流程 | 从定义到执行的流程正常工作 |
| IT-A-002 | 与Core包集成 | 测试与Core包核心功能集成 | 正确使用Core包功能并扩展 |
| IT-A-003 | 与Prompt包集成 | 测试与Prompt包集成 | 成功集成Prompt包功能处理提示词 |
| IT-A-004 | 复杂代理处理 | 测试处理复杂代理定义 | 成功处理包含各种配置的复杂代理 |
| IT-A-005 | 多文件继承 | 测试跨文件继承处理 | 成功解析和处理跨文件继承 |
| IT-A-006 | 与外部API集成 | 测试与外部LLM API集成 | 成功集成并调用外部API |
| IT-A-007 | 持久化存储集成 | 测试与持久化存储集成 | 成功使用持久化存储保存状态和记忆 |
| IT-A-008 | CLI工具集成 | 测试与CLI工具集成 | 成功通过CLI运行代理 |

## 12. 性能测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| PT-A-001 | 基本性能测试 | 测试基本处理性能 | 处理时间在可接受范围内 |
| PT-A-002 | 内存占用分析 | 测试处理过程内存占用 | 内存占用在合理范围内，无泄漏 |
| PT-A-003 | 长时间运行稳定性 | 测试长时间运行稳定性 | 长时间运行不出现内存泄漏或性能下降 |
| PT-A-004 | 大规模记忆管理 | 测试大规模记忆管理性能 | 大量记忆项处理性能在可接受范围内 |
| PT-A-005 | 并发处理性能 | 测试并发处理多个代理 | 并发处理正常工作，性能提升明显 |
| PT-A-006 | API调用效率 | 测试API调用效率 | API调用次数和参数优化合理 |
| PT-A-007 | token使用效率 | 测试token使用效率 | token使用量在合理范围内，没有不必要的浪费 |

## 13. 实际用例测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UC-A-001 | 研究助手代理 | 测试研究助手代理用例 | 代理能正确执行研究助手功能 |
| UC-A-002 | 编程助手代理 | 测试编程助手代理用例 | 代理能正确执行编程助手功能 |
| UC-A-003 | 客服代理 | 测试客服代理用例 | 代理能正确执行客服功能 |
| UC-A-004 | 数据分析代理 | 测试数据分析代理用例 | 代理能正确执行数据分析功能 |
| UC-A-005 | 多轮对话代理 | 测试多轮复杂对话 | 代理能维持上下文并进行多轮对话 |
| UC-A-006 | 多模型切换代理 | 测试运行时模型切换 | 代理能根据需要切换不同模型 |

## 14. 兼容性测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| CT-A-001 | Node.js版本兼容性 | 测试不同Node.js版本兼容性 | 在支持的Node.js版本上正常工作 |
| CT-A-002 | 浏览器兼容性 | 测试浏览器环境兼容性 | 在浏览器环境中正常工作 |
| CT-A-003 | Core包版本兼容性 | 测试不同Core包版本兼容性 | 与指定范围的Core包版本兼容 |
| CT-A-004 | Prompt包版本兼容性 | 测试不同Prompt包版本兼容性 | 与指定范围的Prompt包版本兼容 |
| CT-A-005 | CommonJS/ESM兼容性 | 测试模块系统兼容性 | 在CommonJS和ESM模块系统中正常工作 |
| CT-A-006 | LLM提供商兼容性 | 测试不同LLM提供商兼容性 | 与主要LLM提供商API兼容 |
| CT-A-007 | API版本兼容性 | 测试不同API版本兼容性 | 适应不同API版本的变化 | 