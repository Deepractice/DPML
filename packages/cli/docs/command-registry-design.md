# DPML CLI 命令注册发现机制设计

本文档描述了 DPML CLI 的命令注册发现机制设计，旨在实现一个松耦合、可扩展的命令行工具系统。

## 设计目标

- **模块化**: CLI 核心与具体领域命令解耦
- **自主注册**: 各领域包自行定义和注册命令
- **动态发现**: CLI 自动发现和加载已注册的命令
- **一致体验**: 保持统一的命令行使用体验
- **扩展性**: 支持第三方扩展

## 核心架构

### 1. 角色划分

- **CLI 核心**：提供命令注册框架、加载机制和执行环境
- **领域包**：各自定义领域特定命令并进行注册
- **命令注册表**：维护所有已注册命令的中央存储

### 2. 注册发现机制

CLI 采用"配置发现"的方式，通过约定和配置自动发现并加载命令：

```
┌───────────────────┐      ┌───────────────────┐
│                   │      │                   │
│   @dpml/prompt    │      │    @dpml/agent    │
│                   │      │                   │
│  ┌─────────────┐  │      │  ┌─────────────┐  │
│  │  命令定义   │  │      │  │  命令定义   │  │
│  └─────────────┘  │      │  └─────────────┘  │
│         │         │      │         │         │
└─────────┼─────────┘      └─────────┼─────────┘
          │                           │
          ▼                           ▼
    ┌─────────────────────────────────────┐
    │                                     │
    │            命令注册表              │
    │                                     │
    └─────────────────────────────────────┘
                      │
                      ▼
               ┌─────────────┐
               │             │
               │  CLI 执行器 │
               │             │
               └─────────────┘
```

## 具体实现方案

### 1. 命令接口设计

CLI 核心应定义统一的命令接口规范，所有命令必须遵循此接口规范。命令接口应包含：

- 命令名称和描述
- 命令选项定义
- 命令执行逻辑
- 使用示例

同时，需要定义领域命令集合的接口，包含领域名称和该领域下的命令列表。

### 2. 领域包命令注册

每个领域包必须在包根目录提供标准命名的配置文件：

```
/packages/prompt/dpml.config.ts
```

命令配置应当包含领域名称、命令列表及其详细定义（名称、描述、选项、示例等），以及可选的生命周期钩子。

### 3. CLI 命令发现流程

1. **扫描阶段**：CLI 启动时扫描所有 `@dpml/*` 包
2. **配置加载**：查找并加载 `dpml.config.ts` 或编译后的 `dpml.config.js` 配置文件
3. **命令注册**：将发现的命令添加到命令注册表
4. **命令构建**：根据注册表构建命令结构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  扫描可用包    │────▶│  加载命令配置   │────▶│  注册命令      │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  执行命令      │◀────│  解析命令行     │◀────│  构建命令结构   │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 4. 命令加载器概念

CLI 核心应提供命令加载器，负责发现和加载各领域包的命令。加载器主要职责包括：

- 扫描并识别所有可用的 DPML 相关包
- 在这些包中查找 `dpml.config.ts` 配置文件
- 验证配置的有效性和兼容性
- 将命令注册到中央命令注册表

加载器通过手动更新机制更新命令映射：

- 仅当用户显式使用 `--update` 选项时才执行包扫描和映射更新
- 不自动检测包版本变更或自动更新映射
- 首次使用CLI时需要手动执行 `--update` 初始化映射

## 扩展机制

### 1. 第三方扩展

第三方开发者可以创建兼容的包来扩展 DPML CLI：

1. 创建符合命名约定的包（如 `dpml-plugin-*`）
2. 在包根目录提供标准格式的 `dpml.config.ts` 文件

CLI 将自动发现并加载这些扩展。

### 2. 本地命令

支持在项目级别定义自定义命令：

1. 在项目根目录创建 `.dpml/dpml.config.ts` 文件
2. 使用标准格式定义命令
3. CLI 优先加载这些本地命令

## 生命周期钩子

CLI 应提供生命周期钩子机制，允许领域包在关键点执行自定义逻辑。常见钩子包括：

- 初始化钩子：CLI 启动时执行
- 退出钩子：CLI 退出前执行
- 命令前钩子：命令执行前调用
- 命令后钩子：命令执行后调用

领域包可通过命令配置定义这些钩子函数。

## 异常处理

1. **配置错误**：检测并报告命令配置中的错误
2. **版本兼容**：验证命令与 CLI 核心的兼容性
3. **冲突处理**：处理命令名称冲突的策略
   - 默认按包依赖顺序处理
   - 支持显式优先级设置

## 性能考虑

为确保 CLI 快速响应，应采取以下优化：

1. **懒加载**：只在实际需要时加载命令实现
2. **缓存机制**：缓存已发现的命令配置
3. **并行加载**：并行处理独立包的命令加载

## 测试策略

1. **模拟包**：使用模拟包测试发现机制
2. **集成测试**：验证完整的命令发现和执行流程
3. **单元测试**：测试各组件的独立功能

## 总结

这种命令注册发现机制设计实现了 CLI 核心与具体领域命令的解耦，使系统更加模块化和可扩展。各领域包可以自主定义和注册命令，而 CLI 负责发现、加载和执行这些命令，形成一个灵活且统一的命令行工具系统。
