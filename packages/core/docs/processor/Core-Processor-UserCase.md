# DPML Processor 测试用例

本文档描述了Processor模块的单元测试和集成测试用例，旨在保证Processor的功能正确性和稳定性。Processor作为DPML处理流程中的处理层，负责处理标签继承、引用解析和基础元数据生成。

## 1. 核心功能单元测试

### 1.1 Processor基础功能

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-P-001 | 基本文档处理 | 测试处理器能否处理最简单的文档，不含继承或引用 | 返回已处理的文档，保持基础结构不变 |
| UT-P-002 | 访问者注册与排序 | 测试处理器能否正确注册访问者并按优先级排序 | 访问者按优先级高到低排序 |
| UT-P-003 | 协议处理器注册 | 测试处理器能否正确注册协议处理器 | 协议处理器成功注册并可被引用解析器使用 |
| UT-P-004 | 引用解析器设置 | 测试能否替换默认引用解析器 | 自定义引用解析器被正确设置并被使用 |
| UT-P-005 | 节点处理顺序 | 测试处理器是否按正确顺序处理节点 | 父节点先于子节点被处理 |
| UT-P-006 | 处理上下文传递 | 测试处理上下文是否正确创建和传递 | 上下文在整个处理过程中保持一致 |
| UT-P-007 | 标签处理器注册 | 测试能否正确注册标签处理器 | 标签处理器成功注册到对应标签 |
| UT-P-008 | 元数据处理 | 测试基础元数据生成和传递机制 | 生成正确的元数据并附加到节点 |

### 1.2 访问者测试

#### 1.2.1 InheritanceVisitor

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-IV-001 | 基本继承 | 测试简单的元素继承，通过ID引用 | 继承成功，合并属性和内容 |
| UT-IV-002 | 本地文件继承 | 测试从本地文件继承 | 成功加载文件并继承属性和内容 |
| UT-IV-003 | 远程HTTP继承 | 测试从HTTP URI继承 | 成功加载远程资源并继承属性和内容 |
| UT-IV-004 | 属性合并规则 | 测试继承时的属性合并规则 | 子元素属性优先，保留继承的不冲突属性 |
| UT-IV-005 | 内容继承规则 | 测试有内容和无内容时的继承规则 | 有内容时不继承内容，无内容时继承基础内容 |
| UT-IV-006 | 继承不存在元素 | 测试继承不存在的元素 | 抛出适当错误，指明目标未找到 |
| UT-IV-007 | 继承类型不匹配 | 测试继承不同类型的元素 | 严格模式下报错，宽松模式下警告 |
| UT-IV-008 | 循环继承检测 | 测试循环继承情况 | 检测到循环并抛出错误 |

#### 1.2.2 IdValidationVisitor

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-ID-001 | ID收集 | 测试ID收集功能，确保所有ID被正确收集 | 所有ID被正确收集到ProcessingContext中 |
| UT-ID-002 | ID唯一性验证 | 测试ID唯一性验证，确保重复ID被检测出 | 检测到重复ID并报错 |
| UT-ID-003 | ID映射构建 | 测试ID到元素的映射是否正确构建 | 构建正确的ID到元素映射，供引用访问 |
| UT-ID-004 | 严格模式验证 | 测试严格模式下的ID验证行为 | 严格模式下，任何ID问题都导致错误 |
| UT-ID-005 | 无ID元素处理 | 测试对无ID元素的正确处理 | 无ID元素被正确跳过，不影响验证 |

#### 1.2.3 ReferenceVisitor

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-RV-001 | 内容引用识别 | 测试能否正确识别内容中的@引用 | 所有@引用被正确识别和提取 |
| UT-RV-002 | ID引用解析 | 测试对文档内ID引用的解析 | ID引用被正确解析为相应元素 |
| UT-RV-003 | 协议URI解析 | 测试对协议URI的解析 | 协议URI被正确解析，调用相应处理器 |
| UT-RV-004 | 引用替换 | 测试解析后引用在内容中的替换 | 引用在内容中被正确替换为解析结果 |
| UT-RV-005 | 引用节点处理 | 测试对独立Reference节点的处理 | Reference节点被正确解析，resolved属性被设置 |
| UT-RV-006 | 引用错误处理 | 测试无法解析的引用处理 | 根据严格模式决定是报错还是警告 |
| UT-RV-007 | 引用缓存测试 | 测试引用结果是否被正确缓存和复用 | 相同引用只被解析一次，复用缓存结果 |

### 1.3 标签处理器测试

#### 1.3.1 TagProcessorRegistry

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-TR-001 | 处理器注册 | 测试标签处理器注册机制 | 处理器被成功注册到对应标签 |
| UT-TR-002 | 处理器获取 | 测试获取已注册的标签处理器 | 返回对应标签的所有处理器 |
| UT-TR-003 | 多处理器管理 | 测试多个处理器注册到同一标签 | 所有处理器被正确管理并可获取 |
| UT-TR-004 | 处理器优先级 | 测试处理器应用顺序 | 处理器按注册顺序应用 |

#### 1.3.2 DomainTagVisitor

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-DV-001 | 基本标签处理 | 测试对已注册标签的处理 | 相应处理器被调用，元素被正确处理 |
| UT-DV-002 | 未注册标签处理 | 测试对未注册标签的处理 | 元素保持不变 |
| UT-DV-003 | 条件处理 | 测试基于canProcess的条件处理 | 只有符合条件的处理器被调用 |
| UT-DV-004 | 处理器链处理 | 测试多个处理器顺序处理同一标签 | 处理器按顺序依次应用，形成处理链 |
| UT-DV-005 | 处理器错误处理 | 测试处理器抛出错误的情况 | 错误被正确捕获和记录，处理流程适当继续 |

### 1.4 元数据处理测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-MD-001 | 元素元数据 | 测试元素节点的元数据添加与访问 | 元数据成功添加并可被访问 |
| UT-MD-002 | 文档元数据 | 测试文档级元数据收集 | 收集和聚合元素元数据到文档级 |
| UT-MD-003 | 元数据传播 | 测试元数据在处理流程中的传播 | 元数据在各处理阶段正确传递 |
| UT-MD-004 | 元数据合并 | 测试多个来源的元数据合并 | 元数据合并符合预期规则 |

### 1.5 协议处理器测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-PH-001 | HTTP协议处理 | 测试HTTP协议处理器能否获取远程资源 | 成功获取HTTP资源并根据内容类型处理 |
| UT-PH-002 | File协议处理 | 测试文件协议处理器能否读取本地文件 | 成功读取本地文件并根据扩展名处理 |
| UT-PH-003 | ID协议处理 | 测试ID协议处理器能否解析文档内引用 | 成功解析文档内ID引用 |
| UT-PH-004 | 协议处理错误 | 测试协议处理器面对无效资源的行为 | 返回适当错误，包含有用信息 |
| UT-PH-005 | 协议处理超时 | 测试远程资源获取超时情况 | 适当超时处理，不会永久阻塞 |

### 1.6 引用解析器测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-RR-001 | 基本引用解析 | 测试引用解析器的基本解析功能 | 正确解析引用并返回结果 |
| UT-RR-002 | 协议选择逻辑 | 测试引用解析器能否选择正确的协议处理器 | 根据协议选择对应的处理器 |
| UT-RR-003 | 引用解析缓存 | 测试解析结果的缓存机制 | 重复引用使用缓存结果 |
| UT-RR-004 | 未知协议处理 | 测试对未知协议的处理 | 返回明确的错误信息 |
| UT-RR-005 | 解析结果格式 | 测试解析结果的格式和结构 | 结果包含必要的字段和信息 |

## 2. 扩展机制测试

### 2.1 访问者扩展

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-EV-001 | 自定义访问者注册 | 测试自定义访问者的注册和使用 | 自定义访问者被正确注册并执行 |
| UT-EV-002 | 多访问者协作 | 测试多个访问者处理同一节点的协作 | 按优先级顺序执行，结果按预期传递 |
| UT-EV-003 | 访问者错误隔离 | 测试一个访问者出错不影响其他访问者 | 错误被处理，处理流程继续 |
| UT-EV-004 | 特定标签处理器 | 测试针对特定标签的处理访问者 | 只处理指定标签，其他标签跳过 |

### 2.2 标签处理器扩展

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-ET-001 | 自定义标签处理器 | 测试自定义标签处理器的注册和使用 | 自定义处理器被正确注册并处理对应标签 |
| UT-ET-002 | 处理器条件处理 | 测试处理器的条件判断逻辑 | 只在条件满足时处理标签 |
| UT-ET-003 | 处理器调用链 | 测试多个处理器的调用链 | 处理器按顺序调用，每个都有机会处理 |
| UT-ET-004 | 元数据扩展 | 测试处理器添加和修改元数据 | 元数据被正确添加和修改 |

### 2.3 协议处理器扩展

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-EP-001 | 自定义协议注册 | 测试自定义协议处理器的注册 | 自定义处理器被正确注册并识别 |
| UT-EP-002 | 自定义协议解析 | 测试自定义协议的解析过程 | 正确解析自定义协议的引用 |
| UT-EP-003 | 协议优先级 | 测试多个处理器可处理同一协议时的选择 | 选择最后注册的处理器 |

### 2.4 引用解析器扩展

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| UT-ER-001 | 自定义解析器设置 | 测试设置自定义引用解析器 | 自定义解析器被正确使用 |
| UT-ER-002 | 引用转换功能 | 测试引用结果的转换功能 | 转换功能正确应用到解析结果 |
| UT-ER-003 | 链式解析器 | 测试链式解析器的实现 | 链式正确传递和处理 |

## 3. 集成测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| IT-001 | 基本处理流程 | 测试完整的处理流程 | 文档被正确处理，所有访问者按顺序执行 |
| IT-002 | 继承和引用组合 | 测试文档中同时包含继承和引用的情况 | 继承和引用都被正确处理 |
| IT-003 | 多级继承和引用 | 测试复杂的多级嵌套继承和引用 | 所有嵌套层次都被正确处理 |
| IT-004 | 复杂文档结构 | 测试具有复杂结构的大型文档 | 复杂文档被正确处理，所有结构保持 |
| IT-005 | 与Parser集成 | 测试Processor与Parser的集成 | Parser输出被Processor正确处理 |

## 4. 错误处理测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| ET-001 | 语法错误处理 | 测试处理语法错误的文档 | 提供清晰的错误信息和位置 |
| ET-002 | 无效引用处理 | 测试无法解析的引用处理 | 根据严格模式适当处理 |
| ET-003 | 循环依赖处理 | 测试循环继承和引用情况 | 检测到循环并提供明确错误 |
| ET-004 | 严格模式错误 | 测试严格模式下的错误处理 | 所有验证错误都导致处理中断 |
| ET-005 | 宽松模式处理 | 测试宽松模式下的错误处理 | 非致命错误被记录但不中断处理 |
| ET-007 | 处理器错误恢复 | 测试标签处理器错误恢复机制 | 单个处理器错误不影响整体处理流程 |

## 5. 性能和边界测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| PT-001 | 大文档处理 | 测试处理大型文档的性能 | 处理时间在可接受范围内，无内存溢出 |
| PT-002 | 多引用处理 | 测试处理包含大量引用的文档 | 所有引用被正确处理，性能可接受 |
| PT-003 | 深度嵌套文档 | 测试处理深度嵌套的文档结构 | 正确处理深度结构，无栈溢出 |
| PT-004 | 引用缓存效果 | 测试引用缓存对性能的影响 | 启用缓存时性能明显提升 |
| PT-005 | 内存使用优化 | 测试处理过程中的内存使用 | 内存使用在合理范围内 |

## 6. 特殊场景测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| ST-001 | 空文档处理 | 测试处理空文档或只有根节点的文档 | 正确处理，不报错 |
| ST-002 | 无根元素文档 | 测试处理无根元素的文档 | 提供明确错误信息 |
| ST-003 | 特殊字符内容 | 测试处理包含特殊字符的内容 | 正确处理，保留特殊字符 |
| ST-004 | XML转义处理 | 测试XML转义字符的处理 | 正确处理转义字符 |
| ST-005 | 标签名大小写 | 测试标签名大小写敏感性 | 按规范处理大小写 |

## 7. 跨平台测试

| 测试ID | 测试名称 | 测试意图 | 预期结果 |
|-------|---------|---------|---------|
| XP-001 | Windows路径处理 | 测试Windows文件路径的处理 | 正确处理Windows路径格式 |
| XP-002 | Unix路径处理 | 测试Unix文件路径的处理 | 正确处理Unix路径格式 |
| XP-003 | 跨平台文件引用 | 测试跨平台文件引用的处理 | 平台无关的路径处理 | 