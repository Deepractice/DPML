# DPML API 变更流程

本文档定义了DPML项目的API变更流程，旨在确保代码、文档和测试的一致性，防止API不一致问题的再次出现。

## 1. API变更类型

根据影响范围和兼容性，API变更分为以下几类：

### 1.1 兼容性变更

- **新增功能**：添加新的方法、属性或类，不影响现有代码
- **扩展功能**：扩展现有接口或类的功能，保持向后兼容
- **废弃标记**：使用`@deprecated`标记即将移除的API，但保留实现
- **可选参数**：为函数添加可选参数，默认行为不变
- **文档改进**：改进API文档，不影响代码实现

### 1.2 破坏性变更

- **删除API**：移除已存在的方法、属性或类
- **重命名API**：改变API的名称
- **参数变更**：修改函数参数类型或顺序
- **返回值变更**：修改函数返回值类型或结构
- **行为变更**：修改API的核心行为

## 2. API变更流程

### 2.1 计划阶段

1. **创建API变更提案**
   - 描述变更动机和目标
   - 分析影响范围
   - 制定兼容性策略

2. **设计审查**
   - 进行设计审查会议
   - 收集反馈和建议
   - 调整变更方案

### 2.2 实施阶段

1. **文档更新**
   - 更新`API-CHANGES.md`，记录变更内容
   - 编写迁移指南
   - 更新相关API文档

2. **代码实现**
   - 实现新的API和变更
   - 为破坏性变更提供兼容层
   - 添加废弃警告

3. **测试开发**
   - 编写API一致性测试
   - 创建迁移测试用例
   - 为新API添加单元测试

4. **示例更新**
   - 更新README示例
   - 更新教程代码
   - 提供迁移示例

### 2.3 审查阶段

1. **代码审查**
   - 确保实现符合设计
   - 检查兼容性处理
   - 验证代码风格

2. **文档审查**
   - 确保文档与实现一致
   - 验证迁移指南的准确性
   - 检查示例的正确性

3. **测试覆盖审查**
   - 验证测试覆盖率
   - 确保关键路径有测试
   - 检查破坏性变更测试

### 2.4 发布阶段

1. **版本控制**
   - 按语义化版本规则选择版本号
   - 为破坏性变更增加主版本号
   - 为新功能增加次版本号

2. **变更日志**
   - 更新CHANGELOG.md
   - 详细描述变更内容
   - 突出破坏性变更和迁移路径

3. **发布公告**
   - 发布版本公告
   - 提供升级指南
   - 强调重要变更

## 3. 检查清单

### 3.1 API设计检查

- [ ] API命名符合项目命名规范
- [ ] 接口定义清晰且职责单一
- [ ] 类型定义完善，避免使用`any`
- [ ] 破坏性变更有明确的迁移路径
- [ ] 考虑了向后兼容性

### 3.2 实现检查

- [ ] 代码实现与设计一致
- [ ] 废弃API添加了`@deprecated`注释
- [ ] 提供了兼容层（如需要）
- [ ] 错误处理完善
- [ ] 性能影响可接受

### 3.3 文档检查

- [ ] `API-CHANGES.md`已更新
- [ ] README示例已更新
- [ ] 提供了迁移指南
- [ ] JSDoc注释完善
- [ ] TypeScript类型定义准确

### 3.4 测试检查

- [ ] 添加了新API的单元测试
- [ ] 包含API一致性测试
- [ ] 添加了迁移测试（对于破坏性变更）
- [ ] 测试覆盖率保持或提高
- [ ] 集成测试验证跨包交互

## 4. 兼容性策略

### 4.1 废弃周期

1. **废弃阶段**（至少一个次要版本）
   - 使用`@deprecated`标记
   - 提供替代方案
   - 保持功能正常

2. **删除准备**（至少一个主要版本前通知）
   - 在CHANGELOG中强调将删除
   - 发布预警公告
   - 提供迁移工具

3. **删除执行**（主要版本变更）
   - 移除废弃API
   - 更新所有文档
   - 移除兼容代码

### 4.2 兼容层实现

对于破坏性变更，应提供以下兼容机制之一：

- **API别名**：为重命名的API提供原名称的别名
- **适配层**：为参数或返回值变更提供转换函数
- **遗留模式**：提供选项以启用旧行为
- **类型兼容层**：提供TypeScript类型定义以保持类型兼容

## 5. 最佳实践

### 5.1 API设计原则

- **最小暴露**：只暴露必要的API
- **渐进式变更**：优先考虑兼容性变更，分阶段引入破坏性变更
- **语义化命名**：API命名应反映其功能和用途
- **一致性**：保持与项目现有API风格一致
- **可扩展性**：设计时考虑未来扩展

### 5.2 文档驱动开发

- 先更新文档，后更改代码
- 使用示例说明API用法
- 提供完整的类型定义
- 明确说明API的限制和边界条件

### 5.3 测试策略

- 为每个公共API编写单元测试
- 创建跨模块API集成测试
- 实现API契约测试
- 使用快照测试捕获意外变更
- 自动化验证README示例

## 6. 工具支持

### 6.1 现有工具

- TypeScript编译器：类型检查
- Vitest：测试框架
- API提取器：API签名提取和比较
- ESLint：代码质量检查

### 6.2 计划实现的工具

- API一致性检查器：验证代码与文档的一致性
- API变更影响分析工具：识别受影响的模块
- README示例验证工具：确保示例可运行
- API版本比较工具：可视化显示API差异

## 7. 责任分工

- **API设计者**：负责API设计和变更提案
- **实现者**：负责代码实现和单元测试
- **文档维护者**：负责更新文档和变更记录
- **测试专家**：负责API一致性测试和契约测试
- **审查者**：负责审查变更并提供反馈

## 8. 流程执行示例

### 场景：重命名一个API方法

1. **计划阶段**
   - 创建变更提案："将`parseXML`重命名为`parseElement`以更准确反映功能"
   - 分析影响：影响所有使用`parseXML`的代码

2. **实施阶段**
   - 更新`API-CHANGES.md`，记录变更和迁移路径
   - 实现新的`parseElement`方法
   - 保留`parseXML`方法，添加`@deprecated`标记
   - 创建API一致性测试，确保两个方法行为一致
   - 更新README和示例代码

3. **审查阶段**
   - 代码审查确保实现正确
   - 文档审查确保迁移指南清晰
   - 测试审查确保覆盖率充分

4. **发布阶段**
   - 发布次版本更新
   - 在CHANGELOG中记录变更
   - 发布公告，强调废弃警告