# DPML Core 模块测试失败问题汇总

本文档汇总了 DPML Core 模块中测试未通过的问题，按照模块和功能分类，并提供修复建议。

## 1. Transformer 模块

### 1.1 错误处理机制

#### 访问者错误处理
- **问题**: 在 `visitorErrorHandling.test.ts` 测试中，错误消息格式与预期不符
- **失败案例**: 
  ```
  expected '转换错误: 访问者 anonymous 处理 document 节点时出错:' to contain '访问者错误'
  ```
- **修复建议**: 
  - 修正 `DefaultTransformer.handleVisitorError` 方法中的错误消息格式
  - 确保错误消息包含测试中预期的关键词

#### 严格模式错误处理
- **问题**: 在严格模式下未正确抛出错误
- **失败案例**: 
  ```
  expected [Function] to throw an error
  ```
- **修复建议**: 
  - 检查 `DefaultTransformer.transform` 方法中的严格模式错误处理逻辑
  - 确保在严格模式下正确抛出并传递错误

#### 宽松模式错误处理
- **问题**: 错误消息格式不匹配和日志记录问题
- **失败案例**: 
  ```
  expected "error" to be called at least once
  ```
- **修复建议**: 
  - 检查 `console.error` 的调用时机
  - 修正错误消息格式以匹配测试预期

#### 错误恢复和自愈机制
- **问题**: 访问者禁用机制未正常工作
- **失败案例**: 
  ```
  expected "warn" to be called with arguments: [ Array(1) ]
  ```
- **修复建议**: 
  - 完善 `VisitorManager` 中的错误计数和访问者禁用机制
  - 确保警告消息包含预期内容

### 1.2 访问者返回值处理机制

#### 结果合并问题
- **问题**: 未正确合并多个访问者的返回值
- **失败案例**: 
  ```
  expected [ { type: 'document', …(1) }, …(1) ] to deeply equal { type: 'document', …(2) }
  ```
- **修复建议**: 
  - 实现深度合并策略
  - 完善对象和数组的合并规则

#### 数组值合并
- **问题**: 数组类型返回值未正确连接
- **失败案例**: 
  ```
  expected [ { tags: [ '文档', '重要' ] }, …(1) ] to deeply equal { tags: [ '文档', '重要', '参考' ] }
  ```
- **修复建议**: 
  - 为数组类型实现特殊的合并逻辑
  - 确保 `mergeReturnValues` 选项正确处理数组连接

#### 冲突解决策略
- **问题**: 未正确应用冲突解决策略
- **失败案例**: 
  ```
  expected [ { type: 'doc', version: 1 }, …(1) ] to deeply equal { type: 'doc', version: 1 }
  ```
- **修复建议**: 
  - 实现 `resolveConflicts` 策略
  - 添加针对不同策略的处理逻辑

### 1.3 访问者优先级机制

#### 执行顺序问题
- **问题**: 访问者执行顺序不符合预期
- **失败案例**: 
  ```
  expected [ '访问者1', '访问者2', '访问者3' ] to deeply equal [ '访问者1', '访问者2' ]
  ```
- **修复建议**: 
  - 修复 `DefaultTransformer.transformDocument` 和其他转换方法
  - 确保在第一个返回非空结果的访问者后停止执行

#### 节点处理顺序
- **问题**: 不同类型节点的处理顺序不正确
- **失败案例**: 
  ```
  expected [ 'document' ] to deeply equal [ 'document', 'element' ]
  ```
- **修复建议**: 
  - 检查节点递归处理逻辑
  - 确保节点处理按照预期顺序执行

### 1.4 父结果传递机制

#### 嵌套结构处理
- **问题**: 未正确传递和处理父节点结果
- **失败案例**: 
  ```
  expected { type: 'document', …(2) } to deeply equal { type: 'document', …(2) }
  ```
- **修复建议**: 
  - 修复 `TransformContext` 中的父结果处理
  - 确保上下文中正确维护父节点信息

#### 祖先节点信息访问
- **问题**: 无法正确获取祖先节点信息
- **失败案例**: 
  ```
  expected { type: 'content', …(4) } to deeply equal { type: 'content', …(4) }
  ```
- **修复建议**: 
  - 改进上下文管理器中的祖先节点信息传递
  - 添加辅助方法获取完整的祖先链信息

### 1.5 性能和边界测试

#### 内容计数
- **问题**: 大文档转换时内容计数不正确
- **失败案例**: 
  ```
  - 5000
  + 0
  ```
- **修复建议**: 
  - 修复 `CountingVisitor` 的计数逻辑
  - 确保所有子节点都被正确计数

## 2. Processor 模块

### 2.1 错误恢复机制

#### 错误恢复启用
- **问题**: 启用错误恢复时未继续处理
- **失败案例**: 
  ```
  expected +0 to be 1
  ```
- **修复建议**: 
  - 修复错误恢复逻辑
  - 确保记录错误并继续处理其他节点

#### 错误处理模式
- **问题**: 不同严重级别的错误处理不正确
- **失败案例**: 
  ```
  expected false to be true
  ```
- **修复建议**: 
  - 改进不同严重级别错误的处理策略
  - 实现更细粒度的错误控制

### 2.2 内存使用和性能

#### 内存释放问题
- **问题**: 测试中的常量赋值问题
- **失败案例**: 
  ```
  TypeError: Assignment to constant variable.
  ```
- **修复建议**: 
  - 修改测试代码，使用 `let` 而非 `const` 声明变量
  - 或使用其他策略释放引用

### 2.3 协议处理器

#### 路径处理问题
- **问题**: 路径规范化函数缺失
- **失败案例**: 
  ```
  No "normalize" export is defined on the "path" mock
  ```
- **修复建议**: 
  - 修复 `path` 模块的模拟实现
  - 确保包含所有必要的导出函数

## 3. 优先级和修复计划

按照影响范围和重要性，建议按以下顺序修复问题：

1. **高优先级**
   - 严格模式错误处理问题
   - 访问者优先级和执行顺序问题
   - 父结果传递机制问题

2. **中优先级**
   - 访问者返回值合并问题
   - 宽松模式错误处理问题
   - 错误恢复和自愈机制

3. **低优先级**
   - 内存使用和性能问题
   - 路径处理模拟问题
   - 其他边界情况测试

## 4. 后续步骤

1. 从高优先级问题开始修复
2. 为每个修复添加额外的单元测试
3. 增加对边界情况的处理
4. 完善错误处理文档
5. 优化性能和内存使用
6. 考虑添加更多日志记录和调试信息 