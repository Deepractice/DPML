# DPML Prompt 测试用例

本文档描述了`@dpml/prompt`包的单元测试和集成测试用例，旨在保证提示模块的功能正确性和稳定性。`@dpml/prompt`作为DPML的第一个领域包，负责提示词的结构化定义、处理和转换。

## 1. 标签定义与注册测试

| 测试ID   | 测试名称       | 测试意图               | 预期结果                             |
| -------- | -------------- | ---------------------- | ------------------------------------ |
| UT-P-001 | 基础标签注册   | 测试8个核心标签的注册  | 所有标签被正确注册到TagRegistry      |
| UT-P-002 | 标签属性验证   | 测试标签属性定义与验证 | 各标签属性正确验证，必需属性检查有效 |
| UT-P-003 | 标签嵌套规则   | 测试标签嵌套规则定义   | 正确验证嵌套关系，拒绝非法嵌套       |
| UT-P-004 | 标签ID唯一性   | 测试标签ID唯一性验证   | 重复ID被检测并报错                   |
| UT-P-005 | 自定义验证规则 | 测试自定义验证逻辑     | 自定义验证规则生效并返回预期结果     |

## 2. 标签处理器测试

### 2.1 PromptTagProcessor

| 测试ID    | 测试名称     | 测试意图                      | 预期结果                         |
| --------- | ------------ | ----------------------------- | -------------------------------- |
| UT-PP-001 | 基本属性处理 | 测试基本属性(id, version)处理 | 属性被正确提取到元数据           |
| UT-PP-002 | lang属性处理 | 测试语言属性处理              | 语言属性被正确识别并影响后续处理 |
| UT-PP-003 | 子标签收集   | 测试子标签的收集与验证        | 子标签被正确收集并验证           |

### 2.2 RoleTagProcessor

| 测试ID    | 测试名称        | 测试意图             | 预期结果                                            |
| --------- | --------------- | -------------------- | --------------------------------------------------- |
| UT-RP-001 | 基本属性处理    | 测试角色基本属性处理 | 属性被正确提取到元数据                              |
| UT-RP-002 | 属性验证        | 测试角色属性验证规则 | 属性验证规则正确执行                                |
| UT-RP-003 | extends属性处理 | 测试角色继承处理     | 正确提取和记录extends属性值（继承逻辑由Core包处理） |

### 2.3 ContextTagProcessor

| 测试ID    | 测试名称        | 测试意图               | 预期结果                                            |
| --------- | --------------- | ---------------------- | --------------------------------------------------- |
| UT-CP-001 | 基本属性处理    | 测试上下文基本属性处理 | 属性被正确提取到元数据                              |
| UT-CP-002 | 属性验证        | 测试上下文属性验证规则 | 属性验证规则正确执行                                |
| UT-CP-003 | extends属性处理 | 测试上下文继承处理     | 正确提取和记录extends属性值（继承逻辑由Core包处理） |

### 2.4 ThinkingTagProcessor

| 测试ID    | 测试名称        | 测试意图                 | 预期结果                                            |
| --------- | --------------- | ------------------------ | --------------------------------------------------- |
| UT-TP-001 | 基本属性处理    | 测试思维框架基本属性处理 | 属性被正确提取到元数据                              |
| UT-TP-002 | 属性验证        | 测试思维框架属性验证规则 | 属性验证规则正确执行                                |
| UT-TP-003 | extends属性处理 | 测试思维框架继承处理     | 正确提取和记录extends属性值（继承逻辑由Core包处理） |

### 2.5 ExecutingTagProcessor

| 测试ID    | 测试名称        | 测试意图                 | 预期结果                                            |
| --------- | --------------- | ------------------------ | --------------------------------------------------- |
| UT-EP-001 | 基本属性处理    | 测试执行步骤基本属性处理 | 属性被正确提取到元数据                              |
| UT-EP-002 | 属性验证        | 测试执行步骤属性验证规则 | 属性验证规则正确执行                                |
| UT-EP-003 | extends属性处理 | 测试执行步骤继承处理     | 正确提取和记录extends属性值（继承逻辑由Core包处理） |

### 2.6 TestingTagProcessor

| 测试ID     | 测试名称        | 测试意图                 | 预期结果                                            |
| ---------- | --------------- | ------------------------ | --------------------------------------------------- |
| UT-TTP-001 | 基本属性处理    | 测试质量检查基本属性处理 | 属性被正确提取到元数据                              |
| UT-TTP-002 | 属性验证        | 测试质量检查属性验证规则 | 属性验证规则正确执行                                |
| UT-TTP-003 | extends属性处理 | 测试质量检查继承处理     | 正确提取和记录extends属性值（继承逻辑由Core包处理） |

### 2.7 ProtocolTagProcessor

| 测试ID     | 测试名称        | 测试意图                 | 预期结果                                            |
| ---------- | --------------- | ------------------------ | --------------------------------------------------- |
| UT-PRP-001 | 基本属性处理    | 测试交互协议基本属性处理 | 属性被正确提取到元数据                              |
| UT-PRP-002 | 属性验证        | 测试交互协议属性验证规则 | 属性验证规则正确执行                                |
| UT-PRP-003 | extends属性处理 | 测试交互协议继承处理     | 正确提取和记录extends属性值（继承逻辑由Core包处理） |

### 2.8 CustomTagProcessor

| 测试ID     | 测试名称        | 测试意图                   | 预期结果                                            |
| ---------- | --------------- | -------------------------- | --------------------------------------------------- |
| UT-CTP-001 | 基本属性处理    | 测试自定义内容基本属性处理 | 属性被正确提取到元数据                              |
| UT-CTP-002 | 属性验证        | 测试自定义内容属性验证规则 | 属性验证规则正确执行                                |
| UT-CTP-003 | extends属性处理 | 测试自定义内容继承处理     | 正确提取和记录extends属性值（继承逻辑由Core包处理） |

## 3. 继承机制测试

| 测试ID   | 测试名称       | 测试意图                | 预期结果                                 |
| -------- | -------------- | ----------------------- | ---------------------------------------- |
| UT-I-001 | 基本继承处理   | 测试基本extends属性处理 | 成功继承源标签的属性和内容               |
| UT-I-002 | 属性合并规则   | 测试属性合并逻辑        | 目标属性优先，源属性作为补充             |
| UT-I-003 | 内容继承规则   | 测试内容继承逻辑        | 目标有内容则使用目标内容，否则继承源内容 |
| UT-I-004 | 元数据合并     | 测试元数据合并逻辑      | 元数据正确合并，保留必要信息             |
| UT-I-005 | 本地文件继承   | 测试本地文件引用继承    | 成功从本地文件解析并继承                 |
| UT-I-006 | 远程文件继承   | 测试远程文件引用继承    | 成功从远程文件解析并继承                 |
| UT-I-007 | 多级继承       | 测试多级继承链          | 多级继承正确传递属性和内容               |
| UT-I-008 | 循环继承检测   | 测试循环继承检测        | 检测到循环继承并报错                     |
| UT-I-009 | 不存在引用处理 | 测试不存在的引用处理    | 提供明确错误消息，指出引用路径无效       |

## 4. 转换器测试

### 4.1 PromptTransformer基础功能

| 测试ID    | 测试名称       | 测试意图               | 预期结果                       |
| --------- | -------------- | ---------------------- | ------------------------------ |
| UT-PT-001 | 基本转换功能   | 测试基本转换功能       | 成功转换为纯文本提示           |
| UT-PT-002 | 标签序列化测试 | 测试各标签序列化成文本 | 各标签正确序列化为预期格式     |
| UT-PT-003 | 转换选项配置   | 测试转换选项影响       | 选项正确影响输出结果           |
| UT-PT-004 | 空值处理       | 测试空标签和空内容处理 | 空值被适当处理，不产生多余空白 |
| UT-PT-005 | Markdown转换   | 测试Markdown内容转换   | Markdown内容被正确转换         |

### 4.2 格式配置测试

| 测试ID    | 测试名称       | 测试意图             | 预期结果                           |
| --------- | -------------- | -------------------- | ---------------------------------- |
| UT-FC-001 | 默认格式应用   | 测试默认格式模板     | 默认格式被正确应用到输出           |
| UT-FC-002 | 自定义格式模板 | 测试自定义格式模板   | 自定义格式正确覆盖默认设置         |
| UT-FC-003 | 标题前缀后缀   | 测试标题、前缀和后缀 | 标题、前缀、后缀被正确应用         |
| UT-FC-004 | 内容包装器     | 测试内容包装器函数   | 包装器函数正确处理内容             |
| UT-FC-005 | 标签顺序定制   | 测试自定义标签顺序   | 输出按照指定顺序组织标签           |
| UT-FC-006 | 部分格式覆盖   | 测试部分标签格式覆盖 | 仅覆盖指定标签的格式，其他保持默认 |

### 4.3 多语言支持测试

| 测试ID    | 测试名称       | 测试意图                    | 预期结果                       |
| --------- | -------------- | --------------------------- | ------------------------------ |
| UT-ML-001 | 语言属性处理   | 测试lang属性影响            | lang属性正确影响输出格式和内容 |
| UT-ML-002 | 语言指令添加   | 测试语言指令添加选项        | 语言指令被正确添加到输出末尾   |
| UT-ML-003 | 语言特定格式   | 测试语言特定格式模板        | 语言特定格式被正确应用         |
| UT-ML-004 | 中文特殊处理   | 测试中文特殊格式处理        | 中文格式规则被正确应用         |
| UT-ML-005 | 多语言混合内容 | 测试多语言混合内容处理      | 混合内容被正确处理             |
| UT-ML-006 | API覆盖语言    | 测试API语言设置覆盖文档设置 | API语言设置优先于文档语言设置  |

## 5. API功能测试

### 5.1 generatePrompt函数

| 测试ID     | 测试名称     | 测试意图             | 预期结果                       |
| ---------- | ------------ | -------------------- | ------------------------------ |
| UT-API-001 | 基本生成功能 | 测试基本提示生成功能 | 成功生成纯文本提示             |
| UT-API-002 | 配置选项传递 | 测试配置选项传递     | 选项正确影响生成结果           |
| UT-API-003 | 错误处理机制 | 测试错误处理逻辑     | 错误被正确捕获并转换为友好消息 |
| UT-API-004 | 仅验证模式   | 测试validateOnly选项 | 只执行验证，不生成输出         |
| UT-API-005 | 格式模板传递 | 测试格式模板选项     | 格式模板正确应用到输出         |

### 5.2 processPrompt函数

| 测试ID     | 测试名称     | 测试意图               | 预期结果                   |
| ---------- | ------------ | ---------------------- | -------------------------- |
| UT-PRP-001 | 基本处理功能 | 测试基本处理功能       | 成功解析和处理DPML文本     |
| UT-PRP-002 | 处理选项配置 | 测试处理选项影响       | 选项正确影响处理结果       |
| UT-PRP-003 | 严格模式切换 | 测试严格模式和宽松模式 | 不同模式下错误处理表现正确 |
| UT-PRP-004 | 基础路径设置 | 测试基础路径影响       | 基础路径正确影响引用解析   |

### 5.3 transformPrompt函数

| 测试ID     | 测试名称     | 测试意图             | 预期结果             |
| ---------- | ------------ | -------------------- | -------------------- |
| UT-TRP-001 | 基本转换功能 | 测试基本转换功能     | 成功转换为文本输出   |
| UT-TRP-002 | 转换选项配置 | 测试转换选项影响     | 选项正确影响转换结果 |
| UT-TRP-003 | 标签格式化   | 测试标签格式化选项   | 格式化选项正确应用   |
| UT-TRP-004 | 输出一致性   | 测试相同输入多次转换 | 多次转换结果一致     |

## 6. 错误处理测试

| 测试ID     | 测试名称     | 测试意图               | 预期结果                         |
| ---------- | ------------ | ---------------------- | -------------------------------- |
| UT-ERR-001 | 解析错误处理 | 测试DPML语法错误处理   | 提供友好错误信息，包含位置       |
| UT-ERR-002 | 验证错误处理 | 测试标签验证错误处理   | 提供明确的验证错误信息           |
| UT-ERR-003 | 处理错误处理 | 测试处理过程错误处理   | 提供处理阶段错误信息             |
| UT-ERR-004 | 引用错误处理 | 测试引用解析错误处理   | 提供引用路径错误信息             |
| UT-ERR-005 | 转换错误处理 | 测试转换阶段错误处理   | 提供转换错误信息                 |
| UT-ERR-006 | 未知错误处理 | 测试未分类错误处理     | 提供通用错误信息，不泄露实现细节 |
| UT-ERR-007 | 错误位置信息 | 测试错误位置信息准确性 | 位置信息准确指向错误源           |

## 7. 集成测试

| 测试ID   | 测试名称       | 测试意图                 | 预期结果                           |
| -------- | -------------- | ------------------------ | ---------------------------------- |
| IT-P-001 | 端到端基本流程 | 测试完整处理流程         | 从文本到生成提示的流程正常工作     |
| IT-P-002 | 与Core包集成   | 测试与Core包核心功能集成 | 正确使用Core包功能并扩展           |
| IT-P-003 | 复杂提示处理   | 测试处理复杂提示结构     | 成功处理包含所有标签类型的复杂提示 |
| IT-P-004 | 多文件继承     | 测试跨文件继承处理       | 成功解析和处理跨文件继承           |
| IT-P-005 | 文件系统集成   | 测试与文件系统交互       | 成功读取和处理文件系统中的DPML文件 |
| IT-P-006 | 网络资源集成   | 测试与网络资源交互       | 成功获取和处理网络DPML资源         |
| IT-P-007 | 大型提示处理   | 测试处理大型提示文档     | 处理过程稳定，无内存溢出           |

## 8. 性能测试

| 测试ID   | 测试名称     | 测试意图                 | 预期结果                         |
| -------- | ------------ | ------------------------ | -------------------------------- |
| PT-P-001 | 基本性能测试 | 测试基本处理性能         | 处理时间在可接受范围内           |
| PT-P-002 | 大型文档性能 | 测试处理大型DPML文档性能 | 大型文档处理不超时，内存占用合理 |
| PT-P-003 | 复杂继承性能 | 测试复杂继承链性能       | 复杂继承处理性能在可接受范围内   |
| PT-P-004 | 并发处理性能 | 测试并发处理多个提示文档 | 并发处理正常工作，性能提升明显   |
| PT-P-005 | 内存占用分析 | 测试处理过程内存占用     | 内存占用在合理范围内，无泄漏     |

## 9. 实际用例测试

| 测试ID   | 测试名称       | 测试意图               | 预期结果                       |
| -------- | -------------- | ---------------------- | ------------------------------ |
| UC-P-001 | 数据分析师提示 | 测试数据分析师角色提示 | 生成符合数据分析师特征的提示   |
| UC-P-002 | 编程助手提示   | 测试编程助手角色提示   | 生成符合编程助手特征的提示     |
| UC-P-003 | 金融顾问提示   | 测试金融顾问角色提示   | 生成符合金融顾问特征的提示     |
| UC-P-004 | 医疗咨询提示   | 测试医疗咨询角色提示   | 生成符合医疗咨询特征的提示     |
| UC-P-005 | 多语言提示     | 测试多语言场景提示     | 生成符合语言要求的提示         |
| UC-P-006 | 继承复用提示   | 测试继承和复用场景     | 继承正确工作，提高提示复用能力 |

## 10. 兼容性测试

| 测试ID   | 测试名称             | 测试意图                  | 预期结果                                 |
| -------- | -------------------- | ------------------------- | ---------------------------------------- |
| CT-P-001 | Node.js版本兼容性    | 测试不同Node.js版本兼容性 | 在支持的Node.js版本上正常工作            |
| CT-P-002 | 浏览器兼容性         | 测试浏览器环境兼容性      | 在浏览器环境中正常工作                   |
| CT-P-003 | Core包版本兼容性     | 测试不同Core包版本兼容性  | 与指定范围的Core包版本兼容               |
| CT-P-004 | CommonJS/ESM兼容性   | 测试模块系统兼容性        | 在CommonJS和ESM模块系统中正常工作        |
| CT-P-005 | TypeScript版本兼容性 | 测试TypeScript类型兼容性  | 类型定义在支持的TypeScript版本中正确工作 |
