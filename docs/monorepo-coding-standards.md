# DPML Monorepo项目编码规范

本文档定义了DPML项目中各包之间交互的编码规范，确保代码的可维护性和模块化。

## 包封装原则

1. **黑盒使用原则**
   - 每个包应视为黑盒，只通过公开API交互
   - 不依赖其他包的内部实现细节
   - 包的内部修改不应影响其他包的正常使用

2. **禁止直接引用源码**
   - 严禁使用相对路径直接引用其他包的源代码
   - 不通过文件路径跨越包边界访问内部模块
   - 对其他包的依赖应通过包管理系统解析

3. **API契约优先**
   - 依赖公开文档中描述的API契约，而非源码实现细节
   - 实现可以变化，但API契约应保持稳定
   - 所有跨包交互必须通过公开声明的接口

## 导入规范

1. **包名导入**
   - 使用包名导入: `import { TagRegistry } from '@dpml/core'`
   - 确保package.json中正确声明了依赖关系
   - 使用workspace协议确保本地开发版本可用: `"@dpml/core": "workspace:*"`

2. **禁止路径导入**
   - 禁止使用形如 `import { ... } from '../../../core/src/...'` 的路径导入
   - 不使用相对路径跨越包边界
   - 避免因目录结构变化导致的导入失效

3. **避免路径映射滥用**
   - 不在测试配置中直接映射其他包路径，确保测试环境与实际环境一致
   - tsconfig.json中的paths配置应谨慎使用，不应破坏包的封装性
   - 别名仅用于当前包内部的模块组织，不用于跨包引用

## API使用规范

1. **以文档为准**
   - 严格按照README等文档描述的方式使用API
   - 有疑问时应先查阅文档而非直接查看源码
   - 不对未文档化的行为产生依赖

2. **方法名称准确**
   - 使用精确的方法名，如 `registerTagDefinition()` 而非自行猜测的简写
   - 不依赖内部实现可能提供的便捷方法
   - 遵循API设计者的意图使用接口

3. **参数顺序正确**
   - 按照API文档要求传递参数，不随意调整参数顺序
   - 使用命名参数和对象参数提高代码可读性
   - 对可选参数有清晰的处理逻辑

## 测试规范

1. **隔离性**
   - 测试应该独立于其他包的内部实现
   - 使用模拟(Mock)隔离对其他包的依赖
   - 专注测试当前包的逻辑而非集成场景

2. **API一致性**
   - 测试中调用的方法应与实际API一致，如使用 `isTagRegistered()` 而非 `has()`
   - 测试用例应成为API使用的良好示例
   - 避免在测试中使用内部API或非公开接口

3. **环境一致性**
   - 测试环境配置应尽量接近实际使用环境
   - 避免为测试特殊定制包的导入路径
   - 确保测试能验证实际使用场景

## 工具配置规范

1. **别名限制**
   - alias配置仅用于当前包内部模块引用
   - 在vitest.config.ts等配置中避免映射其他包的内部路径
   - 使用标准包解析机制确保一致性

2. **依赖明确**
   - 显式声明所有依赖，不依赖路径技巧绕过依赖管理
   - 明确区分开发依赖与运行时依赖
   - 依赖版本应明确且受控

3. **包边界清晰**
   - 工具配置不应破坏包的边界和封装性
   - 构建输出应只包含公开API
   - 确保包的独立性与可复用性

## 最佳实践

1. **文档先行**
   - 先阅读包的README和API文档，再开始使用
   - 不确定时参考官方示例代码
   - 避免对未记录行为的依赖

2. **接口稳定**
   - 公开API应保持稳定，避免频繁变更
   - 内部实现可以优化和重构，但不影响外部使用
   - 使用版本控制管理API变更

3. **错误处理**
   - 合理处理API可能返回的错误和异常
   - 不假设其他包的内部实现总是成功
   - 提供清晰的错误信息和回溯路径

遵循这些规范能有效防止包之间的紧耦合，提高代码的可维护性和可靠性，同时减少因内部实现变化导致的连锁问题。 