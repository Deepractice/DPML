# ADR-002: 三方协同模型

**状态**: Accepted
**日期**: 2025-01

## 背景

现代 AI 系统涉及三个核心角色，各自有不同的信息需求：

| 角色       | 需要什么         | 传统方法              | 问题                                |
| ---------- | ---------------- | --------------------- | ----------------------------------- |
| **人类**   | 可观测的系统状态 | 文档与代码分离        | 无法观测 AI 推理过程，文档与实现脱节 |
| **AI**     | 上下文和约束     | Prompt 与配置分离     | 缺乏执行上下文，无法准确转译         |
| **计算机** | 结构化指令       | 配置文件（YAML/JSON） | AI 无法理解，人类难以审计            |

**真实案例**：旅行规划 Agent 的配置分散在 3 个文件：
- `config.yaml`：model、temperature
- `system_prompt.md`：AI 角色定义
- `README.md`：文档（常常已过时）

当产品经理要求"让回答更有创意"，工程师修改 `config.yaml`（temperature 0.7 → 0.9），但忘记更新 `system_prompt.md` 中的"保持准确"指令，`README.md` 文档早已过时。

**结果**：AI 输出飘忽不定，用户投诉增加，花 3 天定位是 temperature 与 prompt 指令冲突。

**核心问题**：传统方法将三方的驱动信息强制分离，协同困难且维护成本高。

## 决策

**DPML 基于"三方定位理论"设计，采用四维语义框架实现三方信息的统一载体。**

### 三方定位理论

现代 AI 系统中的三个核心角色及其不可替代的优势：

| 角色       | 核心能力           | 不可替代的优势                                                                            |
| ---------- | ------------------ | ----------------------------------------------------------------------------------------- |
| **人类**   | 实践 + 意识 → 创新 | 唯一能主动发起实践、从经验中学习并产生真正创新的角色                                      |
| **AI**     | 模式 + 知识 → 映射 | 唯一能**同时**理解自然语言（像人类）和高速处理（像计算机）的角色，最擅长意图与指令间的双向转换 |
| **计算机** | 精确 + 速度 → 效率 | 唯一能以超高速度和绝对精确度执行确定性任务的角色                                          |

**第一性原理**：信息载体必须**同时**服务三方，才能充分发挥现代 AI 系统的潜力。

### 四维语义框架

基于三方本质需求，推导出四维语义的必要且充分性：

| 维度          | 主要服务对象     | 次要服务对象                 | 职责     | 示例                 |
| ------------- | ---------------- | ---------------------------- | -------- | -------------------- |
| **Tag**       | 人类（理解概念） | 计算机（节点类型）、AI（上下文） | 概念定义 | `<prompt>`, `<tool>` |
| **Attribute** | 计算机（解析配置）| AI（理解参数）、人类（查看值） | 配置参数 | `model="llm-model"`  |
| **Content**   | AI（自然语言）   | 人类（阅读）、计算机（提取）   | 语义内容 | `你是助手`           |
| **Structure** | 人类（可视化）   | 计算机（遍历）、AI（层级关系） | 层级组织 | DOM 树               |

**关键洞察**：这不是信息隔离，而是职责优化——每个维度针对特定角色优化（主要职责），但所有角色都能访问所有维度（信息共享）。

### 六态流转模型

DPML 不是静态的配置文件，而是**动态流转的信息载体**。在三个主体之间形成 **3×2 矩阵**，共 6 个信息交换点：

```
┌──────────────────────────────────────────────────────────────┐
│                       六态流转全景                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│   人类 ─────DPML₁────→ 计算机 ─────DPML₃────→ AI             │
│    ↑                      │                    │             │
│    │                      │                    │             │
│  DPML₂                  DPML₅                DPML₄           │
│    │                      │                    │             │
│    │                      ↓                    ↓             │
│   人类 ←───────────── 计算机 ←────DPML₆───── AI             │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

| 态        | 位置            | 角色       | 用途               | 设计目标                          |
| --------- | --------------- | ---------- | ------------------ | --------------------------------- |
| **DPML₁** | 人类→计算机     | 接纳性容器 | 包装用户的自然表达 | 保留人类意图的原始丰富性          |
| **DPML₂** | 计算机→人类     | 可视化结构 | 自动渲染为界面     | 降低人类理解成本，聚焦内容而非格式 |
| **DPML₃** | 计算机→AI       | 结构化框架 | 分层组织上下文信息 | 为 AI 提供完整推理依据            |
| **DPML₄** | AI→计算机       | 可解析命令 | AI 生成的执行指令  | 让计算机能执行 AI 意图            |
| **DPML₅** | 计算机内部      | 精确指令   | 经验证的执行命令   | 保证计算机能无误执行              |
| **DPML₆** | 计算机内部      | 精确数据   | 完整的执行结果     | 为 AI 的下一步推理提供可靠数据源  |

### 统一规范的必要性

尽管六态用途不同，**DPML 协议规范必须统一**：

1. **理论一致**：三方必须共享同一载体，才能实现无损信息流转
2. **信息流转**：不同格式会导致格式转换损耗、信息同步问题、调试困难
3. **工具复用**：一个解析器处理所有六态，简洁高效
4. **认知一致**：开发者、AI、人类看到同一种语言

**设计哲学**：协议统一，角色分化——协议层定义统一语法，实现层根据六态的不同用途优化处理。

## 理由

### 为什么需要三方协同？

传统系统的问题：
- **Markdown Prompt**：只服务 AI（计算机无法可靠解析）
- **JSON/YAML 配置**：主要服务计算机（AI 和人类认知负担高）
- **分离的文档**：信息分散，无法同步

DPML 的核心洞察：需要一种**统一的信息载体**，让同一份文档在三方之间无损流转。

### 为什么是四维语义？

通过穷举三方的最小需求集合，证明四维是必要且充分的：

**三方的本质需求**：

| 角色   | 需求                           |
| ------ | ------------------------------ |
| 人类   | 理解概念（Tag）+ 可视化层级（Structure） |
| AI     | 自然语言空间（Content）+ 上下文层级（Structure） |
| 计算机 | 配置参数（Attribute）+ 可解析格式     |

**维度独立性验证**：

| 尝试合并            | 问题                                         | 结论     |
| ------------------- | -------------------------------------------- | -------- |
| Tag + Attribute     | 概念与配置强制放在同一层级，破坏概念层次     | 不可合并 |
| Content + Attribute | 长文本在 attribute 中格式混乱，多段落不可读  | 不可合并 |
| Structure 用缩进    | 需要"心算"层级，无法直接渲染 DOM 树          | 必须独立 |

**结论**：4 个维度相互独立，任何合并都会违反至少一方的核心需求。

### 为什么需要六态流转？

**全程可观测**：

传统方式的黑盒流转：
```
人类 → [黑盒] → AI → [黑盒] → 计算机 → [黑盒] → 结果
```

DPML 方式的透明流转：
```
人类 → DPML₁ → DPML₃ → AI → DPML₄ → DPML₅ → 计算机 → DPML₆ → AI → DPML₂ → 人类
```

每个中间状态都是结构化的 DPML，可以：
- **调试**：精确定位问题发生在哪一态
- **优化**：分析每一态的性能和准确性
- **审计**：追踪完整的决策过程

**无损流转**：

传统方式的格式转换损耗：
- 自然语言 → JSON（丢失语义上下文）
- JSON → Python 对象（丢失元数据）
- Python 对象 → 日志（丢失结构）

DPML 方式：全程同一种格式，信息在三方之间无损传递。

## 后果

### 正面

1. **信息统一**：
   - 单一文档同时承载配置、指令、文档
   - 修改一处，三方同步感知
   - 降低维护成本

2. **全程可观测**：
   - 每一步流转都是结构化 DPML
   - 支持调试、优化、审计
   - 告别黑盒

3. **角色自适应**：
   - 同一份 DPML，三方各取所需
   - 人类关注语义和结构
   - AI 关注结构和语义
   - 计算机关注格式和配置

4. **认知一致**：
   - 统一语言，降低认知负担
   - 提高协作效率
   - 减少理解偏差

### 负面

1. **设计复杂度**：
   - 需要理解三方定位理论
   - 六态流转增加概念负担
   - **缓解**：开发者通常只需关注 DPML₂（配置 Agent）和 DPML₄/₆（实现工具）

2. **验证复杂度**：
   - 不同态需要不同严格程度的验证
   - DPML₁ 必须宽松（否则用户表达受限）
   - DPML₅/₆ 必须严格（否则执行会出错）
   - **缓解**：协议统一，验证分层（见 ADR-003）

3. **学习曲线**：
   - 三方定位理论需要时间理解
   - **缓解**：实践中开发者无需深入理论，按照规范使用即可

## 开发者视角

从开发者的实际工作场景出发，六态流转对应以下具体的开发活动：

| 态        | 开发者接触的形式             | 开发工作                      |
| --------- | ---------------------------- | ----------------------------- |
| **DPML₁** | 用户输入被框架自动包装       | 设计输入表单，无需关心 DPML 格式 |
| **DPML₂** | 编写 Agent 配置              | 编写 .dpml 配置文件           |
| **DPML₃** | SDK 自动构建 AI 上下文       | 调用 SDK 接口，传入配置       |
| **DPML₄** | AI 返回的工具调用指令        | 实现工具函数，处理调用        |
| **DPML₅** | 框架验证后的执行命令         | 框架自动处理，开发者透明      |
| **DPML₆** | 工具执行结果                 | 返回结构化数据                |

**关键洞察**：开发者通常只需关注 **DPML₂**（配置 Agent）和 **DPML₄/₆**（实现和处理工具），其他三态由框架自动处理。

## 相关决策

- ADR-001: 标记语言选择
- ADR-003: Schema 验证策略

## 参考

- [DPML 白皮书 - 3.1 三方定位理论](/specs/v1.0/zh/whitepaper/index.md#31-第一性原理三方定位理论)
- [DPML 白皮书 - 3.3 六态流转模型](/specs/v1.0/zh/whitepaper/index.md#33-六态流转dpml的动态价值模型)
