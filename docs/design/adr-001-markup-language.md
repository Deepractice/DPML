# ADR-001: 标记语言选择

**状态**: Accepted
**日期**: 2025-01

## 背景

DPML 需要一种信息载体格式，能够同时服务三个核心角色：

1. **人类**：需要可观测的系统状态、可视化的层级结构
2. **AI**：需要自然语言的表达空间、低认知负担的语法
3. **计算机**：需要结构化的配置参数、可解析可验证的格式

传统方案将三方信息强制分离：

| 角色   | 传统方案              | 问题                                |
| ------ | --------------------- | ----------------------------------- |
| 人类   | 文档与代码分离        | 无法观测 AI 推理过程，文档与实现脱节 |
| AI     | Prompt 与配置分离     | 缺乏执行上下文，无法准确转译         |
| 计算机 | 配置文件（YAML/JSON） | AI 无法理解，人类难以审计            |

**核心矛盾**：这些本质上都是 Prompt（给人类的文档、给 AI 的指令、给计算机的配置），却被迫使用不兼容的格式，导致信息无法同步、调试困难、缺少统一的信息流转载体。

## 候选方案评估

### 方案 1: 自定义 DSL

```
@agent travel-planner
  @model llm-model
  @temperature 0.7
  @prompt 你是旅行规划助手
```

**优势**：
- 可针对 AI 场景高度定制
- 表达力强

**劣势**：
- 学习门槛高（用户和 AI 都需要学习新语法）
- 需要编译成最终 Prompt
- 缺少工具生态
- 人类难以直接理解

### 方案 2: YAML

```yaml
agent:
  llm:
    model: llm-model
    temperature: 0.7
  prompt: '你是旅行规划助手'
```

**优势**：
- 人类可读，相对简洁
- 成熟的工具生态

**劣势**：
- **2 维语义**（key + value）无法满足三方差异化需求
- 缩进承载语义，AI 必须"数空格"确定层级
- 配置和内容混在 value 中，没有独立的"内容空间"
- AI 需要理解路径语法（`agent.llm.model`）

### 方案 3: JSON

```json
{
  "agent": {
    "llm": { "model": "llm-model", "temperature": 0.7 },
    "prompt": "你是旅行规划助手"
  }
}
```

**优势**：
- 机器友好，通用性强
- 成熟的解析器生态

**劣势**：
- 与 YAML 类似的 2 维语义问题
- 括号和引号增加 AI 认知负担
- 扁平层级，难以可视化

### 方案 4: 类 XML 标记语法

```xml
<agent>
  <llm model="llm-model" temperature="0.7"/>
  <prompt>你是旅行规划助手</prompt>
</agent>
```

**优势**：
- **4 维语义**（tag/attribute/content/structure）完美映射三方需求
- AI 原生理解（大模型对类 XML 语法有强大的理解和生成能力）
- 可复用成熟的 XML 解析器生态
- DOM 树结构天然可视化
- 不需要编译，直接就是最终形态

**劣势**：
- 相对 JSON 略显冗长
- 传统场景下学习曲线陡峭（但 AI 介质可降低此负担）

## 决策

**DPML 采用类 XML 标记语法**。

### 核心理由：四维语义是必要且充分的最小集合

通过严格的理论推导，我们证明了四维语义的必要性和充分性：

#### 必要性证明

| 需求来源 | 需求描述               | 对应维度      | 为什么不可削减                              |
| -------- | ---------------------- | ------------- | ------------------------------------------- |
| 人类     | 理解"这是什么概念"     | **Tag**       | 概念不能用配置值表达，必须独立              |
| 计算机   | 解析配置参数           | **Attribute** | 参数不能混在自然语言里，必须独立            |
| AI       | 自然语言表达空间       | **Content**   | 自然语言不能受配置语法约束，必须独立        |
| 人类     | 可视化层级结构         | **Structure** | 层级关系是额外维度，缩进表达需心算          |

**缺失任一维度的后果**：

| 缺失维度    | 后果                                                   |
| ----------- | ------------------------------------------------------ |
| 无 Tag      | 人类无法理解概念，计算机无法识别节点类型，AI 缺少上下文 |
| 无 Attribute| 配置参数混入 Content，AI 理解困难，计算机无法结构化解析 |
| 无 Content  | AI 没有自然语言空间，失去灵活性，人类无法自然表达       |
| 无 Structure| 人类无法可视化，计算机遍历困难，AI 难以理解上下文层级   |

#### 充分性证明（反证法）

假设存在第 5 个独立维度 X，则 X 必须同时满足：
1. 独立性：不能被 Tag/Attribute/Content/Structure 表达
2. 必要性：至少一方有不可削减的需求

穷举所有候选维度：

| 候选维度      | 独立性检验                            | 结论   |
| ------------- | ------------------------------------- | ------ |
| 命名空间      | 可用 Attribute 表达：`namespace="mcp"`| 不独立 |
| 注释/文档     | 可用特殊 Tag 表达：`<metadata>`       | 不独立 |
| 样式/展示     | 可用 Attribute 表达：`class="..."`    | 不独立 |
| 版本/状态     | 可用 Attribute 表达：`version="1.0"`  | 不独立 |
| 引用/链接     | 可用 Attribute 表达：`ref="agent-id"` | 不独立 |
| 权限/安全     | 可用 Attribute 表达：`access="..."`   | 不独立 |
| 事件/钩子     | 可用特殊 Tag + Content 表达           | 不独立 |
| 变量/模板     | 可用 Content 内插值或特殊 Tag 表达    | 不独立 |

**结论**：找不到第 5 个独立且必要的维度，4 维是充分的。

### 格式对比评估矩阵

| 评估标准       | 权重 | 自定义 DSL | YAML     | JSON     | 类 XML 语法 |
| -------------- | ---- | ---------- | -------- | -------- | ----------- |
| 语义维度       | 40%  | 4+         | 2        | 2        | 4           |
| AI 认知负担    | 25%  | 高(需学习) | 高(缩进) | 中(括号) | 低(原生)    |
| 工具生态       | 20%  | 无         | 成熟     | 成熟     | 成熟        |
| 可视化能力     | 10%  | 依赖实现   | 弱       | 弱       | 强(DOM)     |
| 扩展性         | 5%   | 高         | 中       | 中       | 高          |
| **总分**       | -    | 65         | 50       | 55       | **95**      |

**权重设计理由**：

- **语义维度（40%）**：直接决定三方协同的可能性
- **AI 认知负担（25%）**：AI 是关键介质，效率影响整体体验
- **工具生态（20%）**：影响实现成本和社区采纳度
- **可视化能力（10%）**：对应人类的可观测性需求
- **扩展性（5%）**：为未来演进预留空间

## 后果

### 正面

1. **三方协同能力**：
   - 每个维度都是三方共享的语义空间
   - 不需要格式转换，信息无损流转

2. **AI 友好性**：
   - 大模型对类 XML 语法有强大的理解和生成能力
   - AI 生成 DPML 的格式正确率 > 95%
   - 不需要学习新语法，认知负担低

3. **人类可读性**：
   - DOM 结构天然可视化
   - 概念边界清晰（`<prompt>` vs `"prompt":`）
   - 层级关系直观（闭合标签 vs 缩进/括号）

4. **工具链复用**：
   - 可复用成熟的 XML 解析器
   - 降低实现门槛
   - 无需开发专用编译器

5. **不需要编译**：
   - 直接就是最终形态
   - 所见即所得

### 负面

1. **冗长性**：
   - 相比 JSON 多约 10-20% 字符
   - **缓解**：冗长是为了语义清晰，这是必要的权衡

2. **学习曲线**：
   - 传统场景下类 XML 语法学习成本高
   - **缓解**：AI 作为介质，人类用自然语言表达意图，AI 自动生成格式正确的 DPML

3. **与 XML 规范的关系**：
   - DPML 借鉴 XML 四维语义，但不强制遵守 XML 全部规范
   - 不使用 DTD/Schema/Namespace 等 XML 高级特性
   - **优势**：可独立演进，根据 AI 场景优化

## 权衡分析

### 冗长性 vs 表达力

```json
// JSON: 简洁但语义模糊
{ "agent": { "llm": { "model": "llm-model" }, "prompt": "你是助手" } }
```

```xml
<!-- 类 XML: 冗长但语义清晰 -->
<agent>
  <llm model="llm-model"/>
  <prompt>你是助手</prompt>
</agent>
```

JSON 节省了约 10 个字符，但失去了：
- 概念的视觉边界
- 层级的清晰表达
- AI 的理解效率

**结论**：为了三方协同，接受适度冗长。

### 学习曲线 vs 长期收益

**传统场景**（人类手写）：需要学习 tag、attribute、entity...

**DPML 场景**（AI 生成）：
1. 人类用自然语言表达意图
2. AI 自动生成格式正确的 DPML
3. 人类通过可视化界面理解和修改

**结论**：通过 AI 介质，将学习负担转移给 AI。

## 相关决策

- ADR-002: 三方协同模型
- ADR-003: Schema 验证策略

## 参考

- [DPML 白皮书 - 3.2 四维语义推导](/specs/v1.0/zh/whitepaper/index.md#32-理论推导四维语义的必要性)
- [DPML 白皮书 - 4.1 格式选择](/specs/v1.0/zh/whitepaper/index.md#41-格式选择)
