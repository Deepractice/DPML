 # 模拟文件系统重构计划

## 问题概述

当前的模拟文件系统(`packages/common/src/testing/mocks/file-system.ts`)存在以下严重问题：

1. **函数重复实现**：
   - `mkdir`、`readdir`、`exists`、`isDirectory` 等方法被重复定义
   - 同时存在同步版本和异步版本，但命名不一致

2. **类型安全问题**：
   - 异步方法中的错误处理缺乏类型检查，如在 `mkdir` 方法中直接访问 `unknown` 类型的 `err.message`

3. **命名混乱**：
   - 部分方法使用 `xxxSync` 命名约定，其他方法没有后缀但仍是同步实现
   - 混合使用同步和异步命名方式

4. **代码重复**：
   - 异步方法只是简单包装同步方法，没有真正的异步行为
   - 相同功能的代码在多处重复

5. **一致性问题**：
   - API 缺乏统一的命名和行为模式
   - 缺少清晰的同步/异步方法区分

## 重构目标

1. 消除所有重复的方法实现
2. 建立清晰一致的命名约定（同步方法使用 `xxxSync` 后缀）
3. 确保类型安全，特别是在错误处理中
4. 减少代码重复，提高可维护性
5. 优化异步实现，确保真正的异步行为
6. 完善文档和注释

## 详细修改计划

### 1. API 结构重组

#### 同步方法（主要实现）
- `readFileSync`
- `writeFileSync`
- `mkdirSync`
- `readdirSync`
- `existsSync`
- `isDirectorySync`
- `isFileSync`
- `statSync`
- `renameSync`
- `copySync`
- `deleteSync` (重命名自 `delete`)

#### 异步方法（包装同步方法）
- `readFile`
- `writeFile`
- `mkdir`
- `readdir`
- `exists`
- `isDirectory`
- `isFile`
- `stat`
- `rename`
- `copy`
- `delete`

### 2. 类型安全改进

- 为所有方法参数和返回值添加明确的类型注解
- 在错误处理中使用类型守卫和类型断言
- 在异步方法中实现适当的错误处理
- 使用 `DpmlError` 类型替代原生 Error

### 3. 代码优化

- 提取共享逻辑到辅助方法
- 使用统一的路径处理逻辑
- 确保事件处理一致性
- 添加适当的边界检查

## 实施步骤

1. **备份与分支**：
   - 创建功能分支 `refactor/mock-file-system`

2. **重构同步 API**：
   - 确保所有同步方法具有 `Sync` 后缀
   - 修复重复实现
   - 添加适当的类型注解

3. **重构异步 API**：
   - 实现所有异步方法作为同步方法的包装器
   - 使用 `Promise.resolve/reject` 确保真正的异步行为
   - 确保适当的错误传播

4. **优化错误处理**：
   - 集成 `packages/common/src/utils/error.ts` 中的错误类型
   - 确保一致的错误消息格式
   - 添加适当的错误代码

5. **完善文档**：
   - 更新所有方法的 JSDoc 注释
   - 添加类和接口的描述
   - 添加使用示例

6. **编写测试**：
   - 为所有方法编写单元测试
   - 测试边界情况和错误处理
   - 测试同步和异步行为的一致性

## 测试策略

1. **单元测试**：
   - 每个同步方法的功能测试
   - 异步方法的正确包装测试
   - 错误处理测试

2. **集成测试**：
   - 多个操作组合的场景测试
   - 事件触发测试
   - 与现有代码的兼容性测试

3. **边界测试**：
   - 空文件/目录处理
   - 大文件处理
   - 深层嵌套目录
   - 路径规范化边界情况

## 风险与缓解

1. **兼容性风险**：
   - **风险**：重构可能破坏依赖于当前实现的测试
   - **缓解**：保持公共 API 签名不变，只重构内部实现

2. **性能风险**：
   - **风险**：重构可能影响性能特别是对大型目录结构
   - **缓解**：添加性能基准测试，确保重构不会降低性能

## 时间估计

| 任务 | 估计时间 |
|------|----------|
| 初始分析与规划 | 0.5 天 |
| 同步 API 重构 | 1 天 |
| 异步 API 重构 | 1 天 |
| 错误处理优化 | 0.5 天 |
| 文档更新 | 0.5 天 |
| 测试编写 | 1.5 天 |
| 代码审查与修复 | 1 天 |
| **总计** | **5 天** |

## 结论

这次重构将显著提高模拟文件系统的代码质量、可维护性和类型安全性。通过建立清晰的 API 约定和消除重复代码，我们可以降低未来出现错误的风险，并使测试更加可靠。