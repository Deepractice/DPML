# DPML Common 开发任务 OES 框架

> 注意：本文档中，`$dpml`表示项目根目录（即整个DPML项目的根目录），例如：`$dpml/docs/monorepo-coding-standards.md`指向项目根目录下的docs文件夹中的monorepo-coding-standards.md文件。

本文档使用OES框架（目标-环境-成功标准）组织`@dpml/common`包的开发任务。每个任务章节包含明确目标、执行环境和成功标准。

## 1. 包结构和基础配置实现

### 目标(O)
- 创建@dpml/common包的基本结构和配置
- 实现模块化结构，支持部分引入
- 设置构建和打包配置
- 确保与其他DPML包的兼容性

### 环境(E)
- **信息资源**
  - 项目编码规范 (`$dpml/docs/monorepo-coding-standards.md`)
  - 测试标准文档 (`$dpml/docs/testing-standards.md`)
  - 架构设计文档 (`$dpml/docs/architecture-domain-based.md`)
- **技术栈**
  - TypeScript 5.x
  - Vitest/Jest测试框架
  - tsup构建工具
  - pnpm包管理器
- **约束条件**
  - 包结构必须支持部分导入，避免不必要的依赖
  - 确保与Node.js和浏览器环境兼容性
  - 最小化外部依赖
  - 提供类型安全的API

### 成功标准(S)
- 基础包结构创建完成，包含logger、testing、utils和types目录
- package.json正确配置，支持部分导入
- 构建配置完成，能生成CJS和ESM格式输出
- 提供完整类型定义
- 基础测试框架配置完成
- README文档包含基本使用说明
- 包能被其他DPML包正确导入

## 2. 通用日志系统实现

### 目标(O)
- 实现跨包通用的日志系统
- 支持多级别日志和自定义格式
- 开发包特定上下文标识功能
- 实现灵活的输出目标配置
- 支持日志级别运行时控制

### 环境(E)
- **信息资源**
  - 项目编码规范 (`$dpml/docs/monorepo-coding-standards.md`)
  - CLI日志系统设计 (`$dpml/packages/cli/docs/implementation-guide.md`相关部分)
  - 测试标准文档 (`$dpml/docs/testing-standards.md`)
- **相关代码**
  - 现有包中的日志实现
  - CLI包中的日志系统
- **约束条件**
  - 最小化外部依赖，尽量使用原生功能
  - 确保浏览器和Node.js兼容性
  - 提供可扩展的接口
  - 支持异步日志操作
  - 性能开销最小化

### 成功标准(S)
- 实现ILogger接口及其标准实现
- 支持debug、info、warn、error等标准日志级别
- 提供根据包名创建日志实例的工厂方法
- 支持JSON和文本格式输出
- 实现控制台输出适配器
- 实现文件输出适配器(Node.js环境)
- 支持自定义格式化器
- 提供日志级别过滤功能
- 通过单元测试验证所有功能
- 提供清晰的文档和使用示例

## 3. 通用测试工具实现

### 目标(O)
- 整合现有testing包功能到common包
- 创建通用测试工具、模拟对象和辅助函数
- 实现测试数据生成和管理工具
- 开发测试环境配置和隔离机制

### 环境(E)
- **信息资源**
  - 测试标准文档 (`$dpml/docs/testing-standards.md`)
  - 现有testing包文档
  - 项目编码规范 (`$dpml/docs/monorepo-coding-standards.md`)
- **相关代码**
  - 现有testing包实现
  - 各包中的测试工具代码
- **约束条件**
  - 保持与现有测试工具的兼容性
  - 支持Vitest/Jest测试框架
  - 最小化外部依赖
  - 提供扩展性好的接口

### 成功标准(S)
- 实现文件系统模拟 (`MockFileSystem`)
- 实现网络请求模拟 (`MockHttpClient`)
- 创建通用测试数据工厂函数集
- 实现测试工具函数(断言辅助、比较工具等)
- 创建测试环境和上下文管理工具
- 提供测试夹具(Fixtures)管理机制
- 实现异步测试辅助工具
- 整合代码覆盖率工具
- 通过单元测试验证所有功能
- 提供详细文档和示例

## 4. 通用工具函数库实现

### 目标(O)
- 创建DPML项目通用工具函数库
- 实现字符串、数组、对象处理函数
- 开发异步操作辅助工具
- 实现路径和文件操作工具
- 创建错误处理和验证工具

### 环境(E)
- **信息资源**
  - 项目编码规范 (`$dpml/docs/monorepo-coding-standards.md`)
  - 各包中的通用功能需求
- **相关代码**
  - 各包中重复出现的工具函数
  - CLI包中的路径工具
- **约束条件**
  - 函数应是纯函数，易于测试
  - 保持浏览器和Node.js兼容性
  - 避免重复实现标准库功能
  - 提供完整类型定义

### 成功标准(S)
- 实现字符串处理工具(格式化、转换、验证等)
- 实现数组操作工具(分组、过滤、转换等)
- 创建对象处理工具(深拷贝、合并、路径访问等)
- 实现异步操作工具(重试、并行控制、队列等)
- 开发路径操作工具(规范化、合并、安全检查等)
- 实现平台检测工具
- 创建错误处理和验证工具
- 所有工具有单元测试覆盖
- 提供详细文档和使用示例

## 5. 共享类型定义实现

### 目标(O)
- 创建DPML项目共享类型定义
- 实现核心领域模型类型
- 开发通用接口和类型别名
- 实现工具类型和类型工具

### 环境(E)
- **信息资源**
  - 项目编码规范 (`$dpml/docs/monorepo-coding-standards.md`)
  - 各包中的类型需求
  - TypeScript最佳实践
- **相关代码**
  - 各包中重复出现的类型定义
  - Core包中的核心类型
- **约束条件**
  - 类型应清晰明确，有良好文档
  - 避免循环依赖
  - 遵循TypeScript最佳实践
  - 保持向后兼容性

### 成功标准(S)
- 创建错误类型和接口
- 实现配置相关类型
- 开发文件系统接口类型
- 实现HTTP客户端接口类型
- 创建事件相关类型
- 开发工具类型集合
- 类型有良好的JSDoc文档
- 提供类型使用示例


## 6. 集成测试和性能验证

### 目标(O)
- 实现common包集成测试套件
- 验证common包与其他包集成的正确性
- 测试并优化性能
- 确保跨环境兼容性

### 环境(E)
- **信息资源**
  - 测试标准文档 (`$dpml/docs/testing-standards.md`)
  - 项目编码规范 (`$dpml/docs/monorepo-coding-standards.md`)
- **相关代码**
  - 已实现的common包功能
  - 使用common包的其他包
- **约束条件**
  - 测试必须覆盖所有关键集成点
  - 性能测试必须有基准和目标
  - 测试必须适应多种环境

### 成功标准(S)
- 实现日志系统集成测试
- 完成测试工具集成测试
- 执行工具函数库集成测试
- 与其他DPML包集成测试
- 编写性能测试并设定基准
- 验证浏览器环境兼容性
- 验证不同Node.js版本兼容性
- 生成集成测试报告
- 性能满足预定目标

## 7. 文档和示例

### 目标(O)
- 创建全面的API文档
- 开发使用示例和教程
- 生成类型文档
- 编写集成指南

### 环境(E)
- **信息资源**
  - 项目编码规范 (`$dpml/docs/monorepo-coding-standards.md`)
  - 现有包文档风格
- **相关代码**
  - 已实现的common包功能
- **约束条件**
  - 文档必须覆盖所有公共API
  - 示例必须实用且可运行
  - 文档风格应与DPML其他文档一致

### 成功标准(S)
- 完整的API参考文档
- 日志系统使用指南和示例
- 测试工具使用指南和示例
- 工具函数库文档和示例
- 类型文档和使用示例
- 集成指南和最佳实践
- 升级和迁移指南
- README包含快速入门指南
- 文档与代码同步
