# 源代码目录结构规则

本文档定义了DPML项目的简化包目录结构规则，旨在确保代码组织的一致性、可维护性和可扩展性。

## 简化的目录结构

每个包应遵循以下简化的目录结构：

```
packages/my-package/
├── src/
│   ├── api/              # 对外暴露的公共API（严格一级目录）
│   │   └── *.ts          # API实现文件
│   │
│   ├── types/            # 对外暴露的类型定义（严格一级目录）
│   │   └── *.ts          # 类型定义文件
│   │
│   ├── core/             # 核心实现逻辑（严格一级目录）
│   │   └── *.ts          # 实现文件
│   │
│   ├── __tests__/        # 测试文件（允许多级目录）
│   │   ├── unit/         # 单元测试
│   │   ├── integration/  # 集成测试
│   │   ├── contract/     # 契约测试
│   │   └── e2e/          # 端到端测试
│   │
│   └── index.ts          # 包主入口（手动维护）
│
└── package.json
```

## 强制扁平化目录结构

为保证代码的一致性和可维护性，我们采用**强制扁平化目录结构**原则：

### 严格限制

1. **一级目录限制**
   - api、types、core目录下**不允许**创建子目录
   - 所有文件必须直接存放在一级目录下
   - 唯一例外：__tests__目录允许有多级结构

2. **禁止的目录结构**
   ```
   // 不允许的结构
   src/api/parser/index.ts
   src/core/utils/helpers.ts
   src/types/models/user.ts
   ```

### 命名约定替代目录嵌套

使用文件命名约定来表达逻辑分组，替代目录嵌套：

```
// 正确的做法
src/api/parser-core.ts
src/api/parser-utils.ts
src/api/processor-api.ts

// 错误的做法
src/api/parser/core.ts
src/api/parser/utils.ts
src/api/processor/api.ts
```

### 文件命名规则

1. **模块前缀**
   - 使用前缀表示功能领域：`parser-xxx.ts`, `formatter-xxx.ts`
   
2. **功能后缀**
   - 使用后缀表示文件类型：`xxx-types.ts`, `xxx-utils.ts`

3. **命名示例**
   - `parser-core.ts` - 解析器核心实现
   - `parser-types.ts` - 解析器类型定义
   - `validation-utils.ts` - 验证相关工具函数

### 扁平化目录结构的优势

- **简化导入路径** - 所有导入最多只需跨越一级目录
- **提高可发现性** - 文件结构一目了然，无需深入多层目录
- **减少重构成本** - 移动或重命名文件不会影响复杂的导入路径
- **促进代码内聚** - 相关功能在命名上保持一致，逻辑上保持内聚

### 索引文件约定

索引文件的使用应当简化：

- src/index.ts是唯一必须的入口文件
- 其他目录下一般不推荐使用index.ts
- 所有导入/导出规则详见《导入与导出规则》文档

## 目录职责详解

### 1. api/ - 对外暴露的公共接口

- **职责**：定义包的外部契约，是用户与包交互的唯一入口
- **内容**：
  - 公共函数、类和接口的实现
  - 对外暴露的工具函数
  - 包装和封装内部实现细节
- **命名规则**：按功能领域命名，如parserApi.ts, processorApi.ts

### 2. types/ - 对外暴露的类型定义

- **职责**：定义包的类型系统，供用户和API使用
- **内容**：
  - 接口(interface)定义
  - 类型别名(type)定义
  - 枚举(enum)定义
  - 对外暴露的错误类型
- **命名规则**：使用PascalCase，按领域分组

### 3. core/ - 内部实现逻辑

- **职责**：实现API所需的功能，不对外暴露
- **内容**：
  - 具体实现代码
  - 内部使用的常量
  - 内部配置参数
  - 内部错误处理
  - 内部工具函数
- **命名规则**：按功能模块组织
- **特性**：可自由重构，不影响外部API

### 4. __tests__/ - 测试文件

- **职责**：验证包的功能和质量
- **内容**：
  - 单元测试 (unit/)
  - 集成测试 (integration/)
  - 契约测试 (contract/)
  - 端到端测试 (e2e/)
- **命名规则**：原文件名.test.ts 或 原文件名.spec.ts

## 目录结构原则

1. **明确的责任分离**
   - api目录：外部接口
   - types目录：类型定义
   - core目录：内部实现

2. **最小暴露原则**
   - 只有api和types目录的内容才能对外暴露
   - core目录内容严格保持内部可见

3. **扁平化目录结构**
   - 保持一级目录结构，避免深度嵌套
   - 使用命名约定而非子目录来组织复杂模块

4. **内聚性优先**
   - 相关功能应该放在一起
   - 内部常量、配置和错误定义靠近使用它们的代码

## 最佳实践

1. **契约优先设计**
   - 先定义API和类型，再实现核心逻辑
   - 关注用户体验和接口稳定性

2. **保持向后兼容**
   - 公共API一旦发布，保持稳定
   - 内部实现可以自由变更

3. **文档与代码同步**
   - 为每个公共API提供完善文档
   - 使用JSDoc注释标注参数和返回值

4. **测试覆盖全面**
   - 公共API需要有契约测试
   - 核心实现需要有单元测试
   - 关键功能需要有集成测试 