# 测试策略规则

本文档定义了DPML类库测试策略的强制规则。

## 1. 分层测试策略

不同架构层次应采用不同的测试策略，针对其在架构中的职责进行有效测试：

| 架构层次 | 测试类型 | 测试重点 | 测试工具 |
|---------|---------|---------|---------|
| **API层和Types层** | 契约测试、端到端测试 | 接口稳定性、类型定义、完整功能路径 | Jest、TypeScript |
| **模块服务层** | 集成测试、单元测试 | 业务逻辑、用例级功能、错误处理、组件协作 | Jest、模拟 |
| **业务类和内部服务类** | 单元测试 | 业务逻辑、边界条件 | Jest、模拟 |

## 2. 测试侧重点

### 2.1 需要单元测试的组件

1. **模块服务单元测试规则**: **模块服务层**的业务逻辑函数必须进行单元测试
2. **业务类单元测试规则**: **业务类**(如Parser)的具体实现必须进行单元测试
3. **内部服务类单元测试规则**: **内部服务类**的核心方法必须进行单元测试
4. **工厂模块单元测试规则**: **工厂模块**的创建逻辑必须进行单元测试

### 2.2 可以不做单元测试的组件

1. **API函数测试例外规则**: **API层函数**(因为只是薄层委托)可以不做单元测试
2. **简单工具函数测试例外规则**: 简单的工具函数可以不做单元测试
3. **纯类型测试例外规则**: 纯数据类型定义可以不做单元测试

## 3. 测试实践规则

### 3.1 契约测试规则

1. **API契约测试规则**: 必须进行契约测试，确保API签名和类型定义不会意外变更
2. **类型兼容性测试规则**: 确保类型系统检测到潜在的破坏性变更

```typescript
// API层契约测试示例
describe('API契约测试', () => {
  it('parse函数应保持签名稳定', () => {
    // 验证函数存在且签名正确
    expect(typeof parse).toBe('function');
    // 调用函数验证基本行为
    const result = parse('<tag>content</tag>');
    expect(result).toHaveProperty('rootNode');
  });
});
```

### 3.2 端到端测试规则

1. **流程完整性规则**: 端到端测试必须验证从API调用到最终结果的完整流程
2. **关键路径规则**: 必须覆盖所有关键业务路径
3. **边界条件规则**: 必须测试关键边界条件和异常处理

### 3.3 集成测试规则

1. **模块服务集成测试规则**: 必须测试模块服务层的用例级功能，包括错误处理
2. **组件协作规则**: 必须测试多个组件协作场景
3. **跨领域功能规则**: 必须测试跨领域功能整合

```typescript
// 模块服务层集成测试示例
describe('parsingService集成测试', () => {
  it('应正确解析并验证文档', () => {
    const result = parseWithValidation('<tag>content</tag>');
    expect(result.valid).toBe(true);
    expect(result.document.rootNode.tagName).toBe('tag');
  });
  
  it('应统一处理解析错误', () => {
    expect(() => parseWithValidation('<<<')).toThrow(ParserError);
  });
});
```

### 3.4 单元测试规则

1. **隔离性规则**: 必须隔离测试模块服务和业务类的核心逻辑
2. **依赖模拟规则**: 必须模拟外部依赖，确保真正的单元测试
3. **边界条件规则**: 必须覆盖边界条件和异常场景

```typescript
// 模块服务层单元测试示例
describe('parsingService单元测试', () => {
  it('findNodeById应返回正确节点', () => {
    const doc = createTestDocument();
    const node = findNodeById(doc, 'test-id');
    expect(node?.tagName).toBe('expected-tag');
  });
});
```

## 4. 组件测试策略表

各组件类型的测试策略应符合以下规则：

| 组件类型 | 主要测试方法 | 测试重点 | 测试示例 |
|---------|------------|----------|---------|
| API层 | 集成测试+契约测试 | 接口稳定性、行为正确性 | 验证API签名和基本功能 |
| 模块服务层 | 单元测试+集成测试 | 业务逻辑正确性，跨域功能组合 | 测试各种业务场景和边界条件，测试跨领域协作 |
| 业务类 | 单元测试 | 功能实现正确性 | 隔离测试每个方法行为 |
| 内部服务类 | 单元测试+状态测试 | 状态管理正确性 | 测试状态变化和并发行为 |

## 5. 测试组织规则

1. **目录结构规则**: 测试文件应按照被测试组件的目录结构组织
2. **命名规则**: 测试文件名应附加`.test.ts`后缀，如`parsingService.test.ts`
3. **测试范围规则**: 每个测试文件应专注于测试单个组件或密切相关的组件集合

## 6. 测试不足的处理规则

1. **优先级规则**: 如果测试资源有限，应优先测试核心业务逻辑和高风险组件
2. **技术债务记录规则**: 对于测试覆盖不足的区域，应明确记录为技术债务
3. **渐进式改进规则**: 随着项目发展，逐步增加测试覆盖范围 