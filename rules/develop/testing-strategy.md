# DPML 测试策略规则

## 1. 测试类型与目标

DPML 项目采用完整的测试金字塔策略，包括以下测试类型：

### 1.1 契约测试 (Contract Tests)
- **目的**: 验证公共API和类型定义的稳定性
- **重点**: 接口签名、类型定义、导出函数
- **位置**: `__tests__/contract/` 目录
- **命名**: `*.contract.test.ts`

### 1.2 单元测试 (Unit Tests)
- **目的**: 验证单个组件的独立功能
- **重点**: 组件内部逻辑、边界条件处理
- **位置**: `__tests__/unit/` 目录
- **命名**: `*.test.ts`

### 1.3 集成测试 (Integration Tests)
- **目的**: 验证多个组件的协作
- **重点**: 组件间接口交互、数据流
- **位置**: `__tests__/integration/` 目录
- **命名**: `*.integration.test.ts`

### 1.4 端到端测试 (End-to-End Tests)
- **目的**: 验证完整功能流程
- **重点**: 用户场景、完整功能路径
- **位置**: `__tests__/e2e/` 目录
- **命名**: `*.e2e.test.ts`

### 1.5 性能测试 (Performance Tests)
- **目的**: 验证性能满足要求
- **重点**: 响应时间、资源使用
- **位置**: `__tests__/performance/` 目录
- **命名**: `*.perf.test.ts`

## 2. 测试优先级

按照测试驱动开发 (TDD) 原则，测试开发和执行的优先级如下：

1. **契约测试** - 保障API和类型的稳定性
2. **单元测试** - 确保基本功能正确
3. **集成测试** - 验证组件协作
4. **端到端测试** - 确认完整功能流程
5. **性能测试** - 验证非功能需求

## 3. 测试覆盖要求

### 3.1 覆盖率目标
- **单元测试**: >90% 行覆盖率，100% 分支覆盖率
- **集成测试**: >80% 行覆盖率
- **端到端测试**: 覆盖所有主要用户场景

### 3.2 测试覆盖重点
- **公共API**: 必须100%覆盖
- **边界条件**: 必须有专门测试
- **错误路径**: 必须验证所有错误处理

## 4. 测试设计原则

### 4.1 单元测试原则
- 每个测试只测试一个概念
- 使用"安排-执行-断言"(AAA)模式
- 测试应独立且可并行运行
- 避免测试私有方法，通过公共API测试行为

### 4.2 模拟策略
- 外部依赖应该被模拟
- 不要模拟被测组件本身
- 使用工厂创建一致的测试数据
- 端到端测试尽量避免模拟

### 4.3 命名规范
- 测试名称应描述"期望行为"和"条件"
- 推荐格式: `should_[预期行为]_when_[条件]`
- 例如: `should_return_error_when_input_is_invalid`

## 5. 测试实现要求

### 5.1 一般要求
- 测试代码质量与产品代码同等重要
- 避免测试代码中的重复逻辑
- 避免在测试中使用条件逻辑
- 每个断言必须有失败消息

### 5.2 测试夹具
- 使用 `beforeEach` 设置重复的测试前置条件
- 使用 `afterEach` 清理资源
- 提取公共测试夹具到专用文件

### 5.3 异步测试
- 总是使用 async/await 处理异步测试
- 确保异步测试有超时保护
- 验证异步错误被正确捕获和处理

## 6. 测试运行与集成

### 6.1 CI集成
- 所有测试必须在CI管道中执行
- 契约测试和单元测试失败应阻断构建
- 提交前必须通过本地测试

### 6.2 测试报告
- 生成测试覆盖率报告
- 趋势分析确保覆盖率不降低
- 测试结果可视化展示

## 7. 维护与重构

### 7.1 测试维护
- 随代码变更同步更新测试
- 定期检查和移除过时测试
- 重构应保持测试兼容性

### 7.2 测试技术债务
- 记录并计划解决脆弱测试
- 优先修复频繁失败的测试
- 避免禁用测试，除非绝对必要 